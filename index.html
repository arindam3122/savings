<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense & Savings Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f5f7fb; --card:#fff;
  --primary:#4f46e5; --success:#16a34a; --danger:#dc2626;
  --text:#1f2937; --muted:#6b7280;
}
*{box-sizing:border-box}

body{
  margin:0;
  padding-top:95px;           /* IMPORTANT: Space for fixed header */
  font-family:"Segoe UI",system-ui;
  background:var(--bg);
  color:var(--text);
}

/* ---------------- FIXED HEADER ---------------- */
header{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#fff;
  padding:26px;
  font-size:26px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;

  position:fixed;             /* FIXED */
  top:0;
  left:0;
  width:100%;
  z-index:999;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}

/* ---------------- SEARCH BAR ---------------- */
.search-input{
  padding:12px 48px 12px 18px;
  border-radius:50px;
  border:2px solid #ececec;
  background:#ffffff;
  font-size:15px;
  width:320px;
  outline:none;
  transition:0.3s ease-in-out;
  box-shadow:0 3px 10px rgba(0,0,0,0.10);
}

.search-input:hover{
  box-shadow:0 4px 14px rgba(0,0,0,0.15);
}

.search-input:focus{
  width:360px;
  border-color:#4f46e5;
  box-shadow:0 6px 20px rgba(79,70,229,0.35);
}

.search-icon{
  position:absolute;
  right:18px;
  top:50%;
  transform:translateY(-50%);
  font-size:18px;
  pointer-events:none;
  color:#6b6b6b;
}

.highlight{
  background:yellow;
  font-weight:bold;
  padding:2px 3px;
  border-radius:4px;
}
/* ------------------------------------------------ */

.container{max-width:1200px;margin:20px auto;padding:20px}

.controls{
  display:flex;
  gap:14px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:30px;
}

select{
  appearance:none;
  padding:12px 44px 12px 16px;
  border-radius:14px;
  border:1.8px solid #e5e7eb;
  background:#fff
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236366f1' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E")
    no-repeat right 14px center;
  background-size:18px;
  font-size:14px;
  font-weight:500;
  min-width:150px;
  cursor:pointer;
  box-shadow:0 8px 22px rgba(0,0,0,.06);
}
select:focus{
  outline:none;
  border-color:#4f46e5;
  box-shadow:0 0 0 4px rgba(99,102,241,.25);
}

button{
  padding:12px 22px;
  border-radius:14px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:500;
  cursor:pointer;
  box-shadow:0 10px 25px rgba(79,70,229,.35);
}

.upload-box{
  border:2px dashed #c7c9ff;
  padding:22px 30px;
  border-radius:18px;
  background:#eef2ff;
  cursor:pointer;
  min-width:280px;
  text-align:center;
}
.upload-box.dragover{
  background:#e0e7ff;
  border-color:#4f46e5;
}
.upload-content{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.upload-icon{font-size:40px}
.upload-text{font-weight:500;color:#3730a3}
.upload-text span{font-size:13px;color:#6b7280}
.loader{
  width:36px;height:36px;
  border:4px solid #c7d2fe;
  border-top-color:#4f46e5;
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.upload-status{font-size:14px;font-weight:500}
.success{color:var(--success)}
.error{color:var(--danger)}

.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:22px;
  margin-bottom:30px;
}
.card{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
}
.card h4{margin:0;color:var(--muted)}
.card h2{margin-top:12px;font-size:30px}
.credit h2{color:var(--success)}
.debit h2{color:var(--danger)}
.saving h2{color:var(--primary)}

.section{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
  margin-bottom:30px;
}

table{width:100%;border-collapse:collapse;margin-top:16px}
th{background:#eef2ff;padding:12px;text-align:left}
td{padding:12px;border-bottom:1px solid #eee}

footer{text-align:center;color:var(--muted);padding:15px}
</style>
</head>

<body>

<header>
  <div>üìä Expense & Savings Dashboard</div>

  <!-- FIXED HEADER + SEARCH BAR -->
  <div style="position:relative;">
    <input 
      type="text" 
      id="searchBar"
      class="search-input"
      placeholder="Search merchants..."
      oninput="merchantSearch()"
    >
    <span class="search-icon">üîç</span>
  </div>
</header>

<div class="container">

<div class="controls">
  <div class="upload-box" id="uploadBox">
    <input type="file" id="fileInput" accept=".xls,.xlsx" hidden>
    <div class="upload-content" id="uploadContent">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">
        Drag & drop Excel file here
        <span>or click to browse</span>
      </div>
    </div>
    <div class="upload-status" id="uploadStatus"></div>
  </div>

  <select id="yearFilter"><option value="">All Years</option></select>
  <select id="monthFilter"><option value="">All Months</option></select>
  <button onclick="applyFilter()">Apply Filter</button>
</div>

<div class="summary">
  <div class="card credit">
    <h4 id="creditTitle">Total Credit</h4>
    <h2 id="credit">‚Çπ0</h2>
  </div>

  <div class="card debit">
    <h4 id="debitTitle">Total Debit</h4>
    <h2 id="debit">‚Çπ0</h2>
  </div>

  <div class="card saving">
    <h4 id="savingTitle">Net Saving</h4>
    <h2 id="saving">‚Çπ0 <span id="savingArrow"></span></h2>
  </div>
</div>

<div class="section">
  <h3>üìà Month-wise Savings Trend</h3>
  <table id="monthTable"></table>
  <canvas id="monthChart"></canvas>
</div>

<div class="section" id="weeklySection" style="display:none">
  <h3 id="weeklyTitle">üóì Weekly Spending</h3>
  <canvas id="weeklyChart"></canvas>
</div>

<div class="section">
  <h3>üè™ Merchant-wise Spending (Full Transaction Log)</h3>

  <!-- üî• AI Insight Box -->
  <div id="aiInsight" 
       style="background:#fef3c7; padding:16px; border-radius:14px; margin-bottom:18px; 
              border-left:6px solid #f59e0b; font-size:15px; display:none;">
  </div>

  <table id="merchantTable"></table>
</div>


</div>

<footer>Built from your Excel data ‚Ä¢ Fully offline & private</footer>

<script>
let rawData=[],filteredData=[],monthChart,weeklyChart;

/* HELPERS */
function formatNumber(n){
  return n.toLocaleString("en-IN",{minimumFractionDigits:2});
}
function getValue(r,k){
  const x=Object.keys(r).find(v=>v.trim().toLowerCase()===k.toLowerCase());
  return x?r[x]:0;
}
function parseDate(v){
  if(typeof v==="number") return new Date((v-25569)*86400*1000);
  const p=v.split("-");
  return new Date(p[2],p[1]-1,p[0]);
}

/* HIGHLIGHT */
function highlightText(text, query) {
  if (!query) return text;
  const regex = new RegExp(`(${query})`, "gi");
  return text.replace(regex, `<span class="highlight">$1</span>`);
}

/* SEARCH ONLY MERCHANT TABLE */
function merchantSearch() {
  const q = document.getElementById("searchBar").value.toLowerCase();
  const rows = merchantTable.getElementsByTagName("tr");

  for (let i = 1; i < rows.length; i++) {
    const cells = rows[i].getElementsByTagName("td");
    let match = false;

    for (let j = 0; j < cells.length; j++) {
      const txt = cells[j].innerText.toLowerCase();

      if (txt.includes(q)) match = true;

      cells[j].innerHTML = highlightText(cells[j].innerText, q);
    }

    rows[i].style.display = match ? "" : "none";
  }
}

/* FILE UPLOAD LOGIC... (unchanged) */
/* -------------------------------- */
uploadBox.onclick=()=>fileInput.click();
["dragenter","dragover"].forEach(e=>{
  uploadBox.addEventListener(e,ev=>{
    ev.preventDefault();
    uploadBox.classList.add("dragover");
  });
});
["dragleave","drop"].forEach(e=>{
  uploadBox.addEventListener(e,ev=>{
    ev.preventDefault();
    uploadBox.classList.remove("dragover");
  });
});
uploadBox.addEventListener("drop",e=>{
  if(e.dataTransfer.files.length) loadExcel(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change",()=>{
  if(fileInput.files.length) loadExcel(fileInput.files[0]);
});

function loadExcel(file){
  uploadContent.innerHTML='<div class="loader"></div>';
  uploadStatus.innerText='Loading file...';

  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"array"});
    rawData=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    filteredData=rawData;
    loadFilters();
    renderAll();
    uploadContent.innerHTML='<div class="upload-icon">‚úÖ</div>';
    uploadStatus.innerHTML='<span class="success">Loaded '+file.name+'</span>';
  };
  r.readAsArrayBuffer(file);
}

/* FILTERS, TOTALS, CHARTS, MERCHANT TABLE ‚Äî unchanged */
/* (kept same as previous working version) */
/* ------------------------------------- */

function loadFilters(){
  const ys=new Set(),ms=new Set();
  rawData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    ys.add(d.getFullYear());
    ms.add(d.getMonth());
  });
  yearFilter.innerHTML='<option value="">All Years</option>';
  [...ys].sort().forEach(y=>yearFilter.innerHTML+=`<option>${y}</option>`);
  monthFilter.innerHTML='<option value="">All Months</option>';
  [...ms].sort().forEach(m=>monthFilter.innerHTML+=`<option value="${m}">${new Date(0,m).toLocaleString("en",{month:"long"})}</option>`);
}

function applyFilter(){
  filteredData=rawData.filter(r=>{
    const d=parseDate(getValue(r,"date"));
    return (!yearFilter.value||d.getFullYear()==yearFilter.value)
        && (!monthFilter.value||d.getMonth()==monthFilter.value);
  });
  renderAll();
}

function renderAll(){
  totals();
  monthWise();
  weeklyWise();
 merchantWise();
 generateAIInsight();    // <-- AI is activated here

}

/* TOTALS */  
function totals(){
  let c=0,d=0;
  filteredData.forEach(r=>{
    c+=+getValue(r,"credit")||0;
    d+=+getValue(r,"debit")||0;
  });
  const net=c-d;

  let title="All Years";
  if(yearFilter.value && monthFilter.value!=="")
    title=new Date(0,monthFilter.value).toLocaleString("en",{month:"long"})+" "+yearFilter.value;
  else if(yearFilter.value)
    title="All Months "+yearFilter.value;
  else if(monthFilter.value!=="")
    title=new Date(0,monthFilter.value).toLocaleString("en",{month:"long"})+" (All Years)";

  creditTitle.innerText=`Total Credit for (${title})`;
  debitTitle.innerText=`Total Debit for (${title})`;
  savingTitle.innerText=`Net Saving for (${title})`;

  credit.innerText=`‚Çπ${formatNumber(c)}`;
  debit.innerText=`‚Çπ${formatNumber(d)}`;
  saving.childNodes[0].nodeValue=`‚Çπ${formatNumber(net)} `;

  if(net>0){
    savingArrow.innerHTML=`<svg width="26" height="26" viewBox="0 0 24 24" stroke="var(--success)" stroke-width="2.8" fill="none"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>`;
  }else if(net<0){
    savingArrow.innerHTML=`<svg width="26" height="26" viewBox="0 0 24 24" stroke="var(--danger)" stroke-width="2.8" fill="none"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>`;
  }else savingArrow.innerHTML="";
}

/* MONTH TABLE */
function monthWise(){
  const map={};
  filteredData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    const k=d.getMonth()+"-"+d.getFullYear();
    if(!map[k]) map[k]={c:0,d:0,date:d};
    map[k].c+=+getValue(r,"credit")||0;
    map[k].d+=+getValue(r,"debit")||0;
  });

  monthTable.innerHTML='<tr><th>Month</th><th>Credit</th><th>Debit</th><th>Saving</th></tr>';
  const labels=[],vals=[];
  Object.values(map).sort((a,b)=>a.date-b.date).forEach(v=>{
    const s=v.c-v.d;
    const lab=v.date.toLocaleString("en",{month:"short",year:"numeric"});
    monthTable.innerHTML+=`<tr><td>${lab}</td><td>${formatNumber(v.c)}</td><td>${formatNumber(v.d)}</td><td>${formatNumber(s)}</td></tr>`;
    labels.push(lab);vals.push(s);
  });

  if(monthChart) monthChart.destroy();
  monthChart=new Chart(document.getElementById("monthChart"),{
    type:"line",
    data:{labels,datasets:[{label:"Net Saving",data:vals,borderWidth:3,tension:.35}]}
  });
}

/* WEEKLY */
function weeklyWise(){
  if(monthFilter.value===""){weeklySection.style.display="none";return;}
  weeklySection.style.display="block";

  const weeks=[0,0,0,0,0];
  filteredData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    const deb=+getValue(r,"debit")||0;
    if(deb>0){
      const w=Math.min(Math.floor((d.getDate()-1)/7),4);
      weeks[w]+=deb;
    }
  });

  if(weeklyChart) weeklyChart.destroy();
  weeklyChart=new Chart(document.getElementById("weeklyChart"),{
    type:"line",
    data:{
      labels:["Week 1","Week 2","Week 3","Week 4","Week 5"],
      datasets:[{label:"Weekly Spending",data:weeks,borderWidth:3,tension:.35}]
    }
  });
}

/* MERCHANT TABLE */
function merchantWise(){
  merchantTable.innerHTML='<tr><th>Date</th><th>Merchant</th><th>Amount</th></tr>';

  const rows = [];

  filteredData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    const merchant=getValue(r,"merchant name");
    const amt=+getValue(r,"debit")||0;

    if(merchant && amt>0){
      rows.push({
        date:d,
        dateLabel:d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),
        merchant,
        amt
      });
    }
  });

  rows.sort((a,b)=>a.date - b.date);

  rows.forEach(row=>{
    merchantTable.innerHTML+=`
      <tr>
        <td>${row.dateLabel}</td>
        <td>${row.merchant}</td>
        <td>‚Çπ${formatNumber(row.amt)}</td>
      </tr>`;
  });
}
function generateAIInsight() {
  const insightBox = document.getElementById("aiInsight");
  insightBox.style.display = "none";

  const totals = {};
  let totalSpend = 0;

  filteredData.forEach(r => {
    const merchant = getValue(r, "merchant name");
    const amt = +getValue(r, "debit") || 0;

    if (merchant && amt > 0) {
      totals[merchant] = (totals[merchant] || 0) + amt;
      totalSpend += amt;
    }
  });

  if (Object.keys(totals).length === 0) return;

  // Find highest spending merchant
  let topMerchant = "";
  let topAmount = 0;

  for (let m in totals) {
    if (totals[m] > topAmount) {
      topMerchant = m;
      topAmount = totals[m];
    }
  }

  const percent = ((topAmount / totalSpend) * 100).toFixed(1);

  insightBox.innerHTML = `
    üß† <b>AI Insight:</b><br>
    Your highest spending is on <b>${topMerchant.toUpperCase()}</b> ‚Äî
    <b>‚Çπ${formatNumber(topAmount)}</b> 
    (${percent}% of your total spending).<br><br>
    ${percent > 40 
      ? "‚ö†Ô∏è You're highly dependent on this merchant ‚Äî consider reviewing unnecessary purchases."
      : "üëç Your expenses look balanced, but reviewing this merchant could still optimize savings."
    }
  `;

  insightBox.style.display = "block";
}

</script>

</body>
</html>
