<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense & Savings Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f5f7fb;--card:#fff;--primary:#4f46e5;
  --success:#16a34a;--danger:#dc2626;
  --text:#1f2937;--muted:#6b7280;
}
*{box-sizing:border-box}

body{
  margin:0;font-family:"Segoe UI",system-ui;
  background:var(--bg);color:var(--text);
}

header{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#fff;padding:26px;text-align:center;
  font-size:26px;font-weight:600;
}

.container{max-width:1200px;margin:20px auto;padding:20px}

.controls{
  display:flex;gap:10px;justify-content:center;
  flex-wrap:wrap;margin-bottom:25px;
}

input,select,button{
  padding:10px 14px;border-radius:8px;
  border:1px solid #ddd;font-size:14px;
}
button{background:var(--primary);color:#fff;border:none;cursor:pointer}
button:hover{opacity:.9}

.summary{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;margin-bottom:30px;
}

.card{
  background:var(--card);padding:22px;border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
}
.card h4{margin:0;color:var(--muted)}
.card h2{margin-top:10px;font-size:28px}
.credit h2{color:var(--success)}
.debit h2{color:var(--danger)}
.saving h2{color:var(--primary)}

.section{
  background:var(--card);padding:22px;border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  margin-bottom:30px;
}

table{
  width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;
}
th{
  background:#eef2ff;color:#3730a3;
  padding:10px;text-align:left;
}
td{padding:10px;border-bottom:1px solid #eee}
tr:nth-child(even){background:#fafafa}

canvas{margin-top:20px}
footer{text-align:center;color:var(--muted);padding:15px;font-size:13px}
</style>
</head>

<body>

<header>üìä Expense & Savings Dashboard</header>

<div class="container">

<div class="controls">
  <input type="file" id="fileInput" accept=".xls,.xlsx">
  <select id="yearFilter"><option value="">All Years</option></select>
  <select id="monthFilter"><option value="">All Months</option></select>
  <button onclick="applyFilter()">Apply Filter</button>
</div>

<div class="summary">
  <div class="card credit">
    <h4 id="creditTitle">Total Credit</h4>
    <h2 id="credit">‚Çπ0</h2>
  </div>

  <div class="card debit">
    <h4 id="debitTitle">Total Debit</h4>
    <h2 id="debit">‚Çπ0</h2>
  </div>

  <div class="card saving">
    <h4 id="savingTitle">Net Saving</h4>
    <h2 id="saving">‚Çπ0 <span id="savingArrow"></span></h2>
  </div>
</div>

<div class="section">
  <h3>üìà Month-wise Saving Trend</h3>
  <table id="monthTable"></table>
  <canvas id="monthChart"></canvas>
</div>

<div class="section" id="weeklySection" style="display:none">
  <h3 id="weeklyTitle">üóì Weekly Spending</h3>
  <canvas id="weeklyChart"></canvas>
</div>

<div class="section">
  <h3>üè™ Merchant-wise Spending</h3>
  <table id="merchantTable"></table>
</div>

</div>

<footer>Built from your Excel data ‚Ä¢ Fully offline & private</footer>

<script>
let rawData=[],filteredData=[],monthChart,weeklyChart;

// ---------- FORMAT ----------
function formatNumber(num){
  return num.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2});
}

function getValue(row,key){
  const k=Object.keys(row).find(x=>x.trim().toLowerCase()===key.toLowerCase());
  return k?row[k]:0;
}

function parseDate(v){
  if(typeof v==="number") return new Date((v-25569)*86400*1000);
  const p=v.split("-");
  return new Date(p[2],p[1]-1,p[0]);
}

function fmt(d){
  return `${String(d.getDate()).padStart(2,'0')}:${String(d.getMonth()+1).padStart(2,'0')}:${d.getFullYear()}`;
}

// ---------- FILE LOAD ----------
fileInput.addEventListener("change",e=>{
  const r=new FileReader();
  r.onload=x=>{
    const wb=XLSX.read(x.target.result,{type:"array"});
    rawData=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    filteredData=rawData;
    loadFilters();
    renderAll();
  };
  r.readAsArrayBuffer(e.target.files[0]);
});

// ---------- FILTERS ----------
function loadFilters(){
  const ys=new Set(),ms=new Set();
  rawData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    ys.add(d.getFullYear()); ms.add(d.getMonth());
  });
  yearFilter.innerHTML='<option value="">All Years</option>';
  [...ys].sort().forEach(y=>yearFilter.innerHTML+=`<option>${y}</option>`);
  monthFilter.innerHTML='<option value="">All Months</option>';
  [...ms].sort().forEach(m=>{
    monthFilter.innerHTML+=`<option value="${m}">${new Date(0,m).toLocaleString('en',{month:'long'})}</option>`;
  });
}

function applyFilter(){
  filteredData=rawData.filter(r=>{
    const d=parseDate(getValue(r,"date"));
    return (!yearFilter.value||d.getFullYear()==yearFilter.value)
        && (!monthFilter.value||d.getMonth()==monthFilter.value);
  });
  renderAll();
}

// ---------- RENDER ----------
function renderAll(){
  totals();
  monthWise();
  merchantWise();
  weeklyWise();
}

// ---------- TOTALS (MONTH + YEAR TITLES) ----------
function totals(){
  let c=0,d=0;
  filteredData.forEach(r=>{
    c+=+getValue(r,"credit")||0;
    d+=+getValue(r,"debit")||0;
  });

  const net=c-d;

  const year=yearFilter.value;
  const month=monthFilter.value;
  let title="All Years";

  if(year && month!==""){
    const m=new Date(0,month).toLocaleString("en",{month:"long"});
    title=`${m} ${year}`;
  }else if(year){
    title=`All Months ${year}`;
  }else if(month!==""){
    const m=new Date(0,month).toLocaleString("en",{month:"long"});
    title=`${m} (All Years)`;
  }

  creditTitle.innerText=`Total Credit for (${title})`;
  debitTitle.innerText=`Total Debit for (${title})`;
  savingTitle.innerText=`Net Saving for (${title})`;

  credit.innerText=`‚Çπ${formatNumber(c)}`;
  debit.innerText=`‚Çπ${formatNumber(d)}`;
  saving.childNodes[0].nodeValue=`‚Çπ${formatNumber(net)} `;

  savingArrow.innerHTML=
    net>0?`<svg width="28" height="28" viewBox="0 0 24 24" stroke="var(--success)" stroke-width="2.8" fill="none">
      <path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>`:
    net<0?`<svg width="28" height="28" viewBox="0 0 24 24" stroke="var(--danger)" stroke-width="2.8" fill="none">
      <path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>`:"";
}

// ---------- MONTH WISE ----------
function monthWise(){
  const map={};
  filteredData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    const k=new Date(d.getFullYear(),d.getMonth(),1).toISOString();
    map[k]=map[k]||{c:0,d:0,date:d};
    map[k].c+=+getValue(r,"credit")||0;
    map[k].d+=+getValue(r,"debit")||0;
  });

  monthTable.innerHTML='<tr><th>Month</th><th>Credit</th><th>Debit</th><th>Saving</th></tr>';
  const labels=[],vals=[];
  Object.values(map).sort((a,b)=>a.date-b.date).forEach(v=>{
    const s=v.c-v.d;
    const lab=new Date(v.date).toLocaleString("en",{month:"short",year:"numeric"});
    monthTable.innerHTML+=`<tr><td>${lab}</td><td>${formatNumber(v.c)}</td><td>${formatNumber(v.d)}</td><td>${formatNumber(s)}</td></tr>`;
    labels.push(lab);vals.push(s);
  });

  if(monthChart)monthChart.destroy();
  monthChart=new Chart(monthChart=document.getElementById("monthChart"),{
    type:"line",
    data:{labels,datasets:[{label:"Net Saving",data:vals,borderWidth:3,tension:.35}]}
  });
}

// ---------- WEEKLY ----------
function weeklyWise(){
  if(monthFilter.value===""){weeklySection.style.display="none";return;}
  weeklySection.style.display="block";

  const year=yearFilter.value || parseDate(getValue(filteredData[0],"date")).getFullYear();
  const m=new Date(0,monthFilter.value).toLocaleString("en",{month:"long"});
  weeklyTitle.innerText=`üóì Weekly Spending ‚Äì ${m} ${year}`;

  const weeks=[0,0,0,0,0];
  filteredData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    const deb=+getValue(r,"debit")||0;
    if(deb>0) weeks[Math.min(Math.floor((d.getDate()-1)/7),4)]+=deb;
  });

  if(weeklyChart)weeklyChart.destroy();
  weeklyChart=new Chart(weeklyChart=document.getElementById("weeklyChart"),{
    type:"line",
    data:{labels:["Week 1","Week 2","Week 3","Week 4","Week 5"],
    datasets:[{label:"Weekly Spending",data:weeks,borderWidth:3,tension:.35}]}
  });
}

// ---------- MERCHANT ----------
function merchantWise(){
  const map={};
  filteredData.forEach(r=>{
    const d=parseDate(getValue(r,"date"));
    const deb=+getValue(r,"debit")||0;
    const m=getValue(r,"merchant name");
    if(deb<=0||!m)return;
    map[m]=map[m]||{t:0,f:d,to:d};
    map[m].t+=deb;
    if(d<map[m].f)map[m].f=d;
    if(d>map[m].to)map[m].to=d;
  });

  merchantTable.innerHTML='<tr><th>Merchant</th><th>Total</th><th>From</th><th>To</th></tr>';
  Object.entries(map).forEach(([k,v])=>{
    merchantTable.innerHTML+=`<tr><td>${k}</td><td>${formatNumber(v.t)}</td><td>${fmt(v.f)}</td><td>${fmt(v.to)}</td></tr>`;
  });
}
</script>

</body>
</html>
