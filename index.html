<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense & Savings Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f5f7fb; --card:#fff;
  --primary:#4f46e5; --success:#16a34a; --danger:#dc2626;
  --text:#1f2937; --muted:#6b7280;
}
*{box-sizing:border-box}

body{
  margin:0;
  padding-top:95px;
  font-family:"Segoe UI",system-ui;
  background:var(--bg);
  color:var(--text);
}

header{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#fff;
  padding:26px;
  font-size:26px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;

  position:fixed;
  top:0; left:0;
  width:100%;
  z-index:999;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}

.search-input{
  padding:12px 48px 12px 18px;
  border-radius:50px;
  border:2px solid #ececec;
  background:#ffffff;
  font-size:15px;
  width:320px;
  outline:none;
  transition:0.3s ease-in-out;
  box-shadow:0 3px 10px rgba(0,0,0,0.10);
}
.search-input:focus{
  width:360px;
  border-color:#4f46e5;
  box-shadow:0 6px 20px rgba(79,70,229,0.35);
}
.search-icon{
  position:absolute;
  right:18px;
  top:50%; transform:translateY(-50%);
  font-size:18px;
  pointer-events:none;
  color:#6b6b6b;
}

mark {
  background: #fff3a3;
  padding: 0 3px;
  border-radius: 4px;
}

.container{max-width:1200px;margin:20px auto;padding:20px}

.controls{
  display:flex;
  gap:14px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:30px;
}

select{
  appearance:none;
  padding:12px 44px 12px 16px;
  border-radius:14px;
  border:1.8px solid #e5e7eb;
  background:#fff
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236366f1' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E")
    no-repeat right 14px center;
  background-size:18px;
  font-size:14px;
  font-weight:500;
  min-width:150px;
  cursor:pointer;
  box-shadow:0 8px 22px rgba(0,0,0,.06);
}

button{
  padding:12px 22px;
  border-radius:14px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:500;
  cursor:pointer;
  box-shadow:0 10px 25px rgba(79,70,229,.35);
}

.upload-box{
  border:2px dashed #c7c9ff;
  padding:22px 30px;
  border-radius:18px;
  background:#eef2ff;
  cursor:pointer;
  min-width:280px;
  text-align:center;
}

.upload-content{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.upload-icon{font-size:40px}
.loader{
  width:36px;height:36px;
  border:4px solid #c7d2fe;
  border-top-color:#4f46e5;
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.upload-status{font-size:14px;font-weight:500}
.success{color:var(--success)}

.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:22px;margin-bottom:30px;
}
.card{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
}
.card h4{margin:0;color:var(--muted)}
.card h2{margin-top:12px;font-size:30px}
.credit h2{color:var(--success)}
.debit h2{color:var(--danger)}
.saving h2{color:var(--primary)}

.section{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
  margin-bottom:30px;
}

table{width:100%;border-collapse:collapse;margin-top:16px}
th{background:#eef2ff;padding:12px;text-align:left}
td{padding:12px;border-bottom:1px solid #eee}

.table-row-highlight:hover{
  background:#f3f4f6; transition:0.2s;
}

.credit-cell { color:#16a34a;font-weight:600; }
.debit-cell { color:#dc2626;font-weight:600; }

footer{text-align:center;color:var(--muted);padding:15px}

#filterLoader{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#filterLoader.show{display:flex;}
/* FIX: Keep Month-wise chart height controlled */
#monthChart {
  width: 100%;
  max-height: 350px !important;
  height: 350px !important;
}
/* FIX: Keep Weekly Spending chart height controlled */
#weeklyChart {
  width: 100%;
  max-height: 350px !important;
  height: 350px !important;
}

</style>
</head>

<body>

<header>
  <div>üìä Expense & Savings Dashboard</div>

  <div style="position:relative;">
    <input 
      type="text" 
      id="searchBar"
      class="search-input"
      placeholder="Search merchants..."
      oninput="debouncedMerchantSearch()"
    >
    <span class="search-icon">üîç</span>
  </div>
</header>

<div class="container">

<div class="controls">
  <div class="upload-box" id="uploadBox">
    <input type="file" id="fileInput" accept=".xls,.xlsx" hidden>
    <div class="upload-content" id="uploadContent">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">Drag & drop Excel file<br><span>or click to browse</span></div>
    </div>
    <div class="upload-status" id="uploadStatus"></div>
  </div>

  <select id="yearFilter"><option value="">All Years</option></select>
  <select id="monthFilter"><option value="">All Months</option></select>
  <button onclick="applyFilter()">Apply Filter</button>
</div>

<div class="summary">
  <div class="card credit">
    <h4 id="creditTitle">Total Credit</h4>
    <h2 id="credit">‚Çπ0</h2>
  </div>

  <div class="card debit">
    <h4 id="debitTitle">Total Debit</h4>
    <h2 id="debit">‚Çπ0</h2>
  </div>

  <div class="card saving">
    <h4 id="savingTitle">Net Saving</h4>
    <h2 id="saving">‚Çπ0 <span id="savingArrow"></span></h2>
  </div>
</div>

<div class="section">
  <h3>üìà Month-wise Savings Trend</h3>
  <table id="monthTable"></table>
  <canvas id="monthChart"></canvas>
</div>

<div class="section" id="weeklySection" style="display:none">
  <h3 id="weeklyTitle">üóì Weekly Spending</h3>
  <canvas id="weeklyChart"></canvas>
</div>

<div class="section">
  <h3>üè™ Merchant-wise Spending (Full Transaction Log)</h3>

  <div id="aiInsight"
       style="background:#fef3c7;padding:16px;border-radius:14px;margin-bottom:18px;
              border-left:6px solid #f59e0b;font-size:15px;display:none;">
  </div>

  <table id="merchantTable"></table>
</div>

</div>

<footer>Built from your Excel data ‚Ä¢ Fully offline & secure</footer>

<div id="filterLoader"><div class="loader"></div></div>
<script>

let rawData = [], filteredData = [], monthChart, weeklyChart;

/* ----------------------------- */
/*         HELPERS               */
/* ----------------------------- */

function formatNumber(n){
  return n.toLocaleString("en-IN",{ minimumFractionDigits: 2 });
}

function getValue(row, key){
  const match = Object.keys(row).find(k => k.trim().toLowerCase() === key.toLowerCase());
  return match ? row[match] : 0;
}

function parseDate(v){
  if(typeof v === "number"){
    return new Date((v - 25569) * 86400 * 1000);
  }
  const p = v.split("-");
  return new Date(p[2], p[1]-1, p[0]);
}

/* ----------------------------- */
/*     SEARCH (FAST + HIGHLIGHT) */
/* ----------------------------- */

let searchTimeout = null;

function debouncedMerchantSearch(){
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(merchantSearch, 150);
}

function merchantSearch(){
  const q = document.getElementById("searchBar").value.toLowerCase();
  const rows = merchantTable.getElementsByTagName("tr");

  for(let i=1; i < rows.length; i++){
    const merchantCell = rows[i].getElementsByTagName("td")[1];

    const originalText =
      merchantCell.getAttribute("data-original") || merchantCell.innerText;

    if(!merchantCell.getAttribute("data-original")){
      merchantCell.setAttribute("data-original", originalText);
    }

    const name = originalText.toLowerCase();

    if(name.includes(q)){
      rows[i].style.display = "";

      if(q.trim() !== ""){
        const regex = new RegExp(`(${q})`, "ig");
        merchantCell.innerHTML = originalText.replace(regex, `<mark>$1</mark>`);
      } else {
        merchantCell.innerHTML = originalText;
      }

    } else {
      rows[i].style.display = "none";
      merchantCell.innerHTML = originalText;
    }
  }
}

/* ----------------------------- */
/*       FILE UPLOAD (SMOOTH)    */
/* ----------------------------- */

uploadBox.onclick = () => fileInput.click();

["dragenter","dragover"].forEach(ev => {
  uploadBox.addEventListener(ev, e=>{
    e.preventDefault();
    uploadBox.classList.add("dragover");
  });
});

["dragleave","drop"].forEach(ev => {
  uploadBox.addEventListener(ev, e=>{
    e.preventDefault();
    uploadBox.classList.remove("dragover");
  });
});

uploadBox.addEventListener("drop", e=>{
  if(e.dataTransfer.files.length){
    loadExcel(e.dataTransfer.files[0]);
  }
});

fileInput.addEventListener("change", ()=>{
  if(fileInput.files.length){
    loadExcel(fileInput.files[0]);
  }
});

async function loadExcel(file){
  filterLoader.classList.add("show");
  uploadContent.innerHTML = '<div class="loader"></div>';
  uploadStatus.innerText = "Loading file...";

  await new Promise(r => setTimeout(r, 50));

  const reader = new FileReader();

  reader.onload = async e => {
    uploadStatus.innerText = "Processing data...";
    await new Promise(r => setTimeout(r, 100));

    const wb = XLSX.read(e.target.result, { type: "array" });
    rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    filteredData = rawData;

    await new Promise(r => setTimeout(r, 60));

    loadFilters();
    renderAll();

    uploadContent.innerHTML = '<div class="upload-icon">‚úÖ</div>';
    uploadStatus.innerHTML = `<span class="success">Loaded ${file.name}</span>`;
    filterLoader.classList.remove("show");
  };

  reader.readAsArrayBuffer(file);
}

/* ----------------------------- */
/*         FILTER SYSTEM         */
/* ----------------------------- */

function loadFilters(){
  const years = new Set(), months = new Set();

  rawData.forEach(r => {
    const d = parseDate(getValue(r,"date"));
    years.add(d.getFullYear());
    months.add(d.getMonth());
  });

  yearFilter.innerHTML = '<option value="">All Years</option>';
  [...years].sort().forEach(y => {
    yearFilter.innerHTML += `<option>${y}</option>`;
  });

  monthFilter.innerHTML = '<option value="">All Months</option>';
  [...months].sort().forEach(m => {
    monthFilter.innerHTML += `
      <option value="${m}">
        ${new Date(0,m).toLocaleString("en",{month:"long"})}
      </option>`;
  });
}

function applyFilter(){
  filterLoader.classList.add("show");

  setTimeout(() => {
    filteredData = rawData.filter(r => {
      const d = parseDate(getValue(r,"date"));
      return (!yearFilter.value || d.getFullYear() == yearFilter.value)
          && (!monthFilter.value || d.getMonth() == monthFilter.value);
    });

    renderAll();
    filterLoader.classList.remove("show");
  }, 200);
}

/* ----------------------------- */
/*      SUMMARY CALCULATIONS     */
/* ----------------------------- */

function buildSummaryTitle(){
  let title = "Overall";

  if(yearFilter.value && monthFilter.value === ""){
    title = `${yearFilter.value} (All Months)`;
  }

  if(!yearFilter.value && monthFilter.value !== ""){
    const m = new Date(0, monthFilter.value).toLocaleString("en",{month:"long"});
    title = `${m} (All Years)`;
  }

  if(yearFilter.value && monthFilter.value !== ""){
    const m = new Date(0, monthFilter.value).toLocaleString("en",{month:"long"});
    title = `${m} ${yearFilter.value}`;
  }

  return title;
}

function totals(){
  let c = 0, d = 0;

  filteredData.forEach(r=>{
    c += +getValue(r,"credit") || 0;
    d += +getValue(r,"debit") || 0;
  });

  const net = c - d;

  credit.innerText = "‚Çπ" + formatNumber(c);
  debit.innerText  = "‚Çπ" + formatNumber(d);
  saving.childNodes[0].nodeValue = "‚Çπ" + formatNumber(net) + " ";

  // Add Month + Year title in summary
  const title = buildSummaryTitle();
  creditTitle.innerText = `Total Credit ‚Äì ${title}`;
  debitTitle.innerText  = `Total Debit ‚Äì ${title}`;
  savingTitle.innerText = `Net Saving ‚Äì ${title}`;

  if(net > 0){
    savingArrow.innerHTML = `
      <svg width="26" height="26" stroke="#16a34a" stroke-width="2.8" fill="none" viewBox="0 0 24 24">
        <path d="M12 19V5"/><path d="M5 12l7-7 7 7"/>
      </svg>`;
  } 
  else if(net < 0){
    savingArrow.innerHTML = `
      <svg width="26" height="26" stroke="#dc2626" stroke-width="2.8" fill="none" viewBox="0 0 24 24">
        <path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/>
      </svg>`;
  }
}
<!-- PART 3/3: Charts, Merchant Table, AI Insight, closing -->

/* ----------------------------- */
/*     RENDERER & CHARTS        */
/* ----------------------------- */

function renderAll(){
  totals();
  // Stagger heavy tasks so UI stays responsive
  setTimeout(monthWise, 30);
  setTimeout(weeklyWise, 60);
  setTimeout(merchantWise, 100);
  setTimeout(generateAIInsight, 140);
}

/* ----------------------------- */
/*        MONTH WISE TABLE       */
/*        + Month Chart          */
/* ----------------------------- */

function monthWise(){
  const map = {};
  filteredData.forEach(r=>{
    const d = parseDate(getValue(r,"date"));
    const key = d.getMonth() + "-" + d.getFullYear();
    if(!map[key]) map[key] = { c:0, d:0, date: d };
    map[key].c += +getValue(r,"credit") || 0;
    map[key].d += +getValue(r,"debit") || 0;
  });

  monthTable.innerHTML = '<tr><th>Month</th><th>Credit</th><th>Debit</th><th>Saving</th></tr>';

  const labels = [], vals = [];
  Object.values(map)
    .sort((a,b) => a.date - b.date)
    .forEach(v => {
      const s = v.c - v.d;
      const lab = v.date.toLocaleString("en",{month:"short", year:"numeric"});

      monthTable.innerHTML += `
        <tr>
          <td>${lab}</td>
          <td>${formatNumber(v.c)}</td>
          <td>${formatNumber(v.d)}</td>
          <td>${formatNumber(s)}</td>
        </tr>`;

      labels.push(lab);
      vals.push(s);
    });

  // Chart
  if(monthChart) monthChart.destroy();
  monthChart = new Chart(document.getElementById("monthChart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "Net Saving",
        data: vals,
        borderWidth: 3,
        tension: 0.35
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

/* ----------------------------- */
/*         WEEKLY CHART          */
/* ----------------------------- */

function weeklyWise(){
  // Only show weekly when user selected a specific month
  if(monthFilter.value === ""){
    weeklySection.style.display = "none";
    return;
  }
  weeklySection.style.display = "block";

  const weeks = [0,0,0,0,0];
  filteredData.forEach(r=>{
    const d = parseDate(getValue(r,"date"));
    const deb = +getValue(r,"debit") || 0;
    if(deb > 0){
      const w = Math.min(Math.floor((d.getDate()-1)/7), 4);
      weeks[w] += deb;
    }
  });

  if(weeklyChart) weeklyChart.destroy();
  weeklyChart = new Chart(document.getElementById("weeklyChart"), {
    type: "line",
    data: {
      labels: ["Week 1","Week 2","Week 3","Week 4","Week 5"],
      datasets: [{
        label: "Weekly Spending",
        data: weeks,
        borderWidth: 3,
        tension: 0.35
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

/* ----------------------------- */
/*       MERCHANT TABLE          */
/* ----------------------------- */

function merchantWise(){
  const rows = [];

  filteredData.forEach(r=>{
    const d = parseDate(getValue(r,"date"));
    rows.push({
      date: d,
      dateLabel: d.toLocaleDateString("en-GB",{day:"2-digit", month:"short", year:"numeric"}),
      merchant: getValue(r,"merchant name"),
      credit: +getValue(r,"credit") || 0,
      debit: +getValue(r,"debit") || 0
    });
  });

  rows.sort((a,b) => a.date - b.date);

  let html = `
    <tr>
      <th>Date</th>
      <th>Merchant</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>`;

  rows.forEach(r => {
    // put merchant text also into data-original attribute for fast highlight later
    const merchantSafe = (r.merchant && String(r.merchant)) || "-";
    html += `
      <tr class="table-row-highlight">
        <td>${r.dateLabel}</td>
        <td data-original="${escapeHtml(merchantSafe)}">${escapeHtml(merchantSafe)}</td>
        <td class="${r.credit>0 ? "credit-cell" : ""}">${r.credit>0 ? "‚Çπ" + formatNumber(r.credit) : "-"}</td>
        <td class="${r.debit>0 ? "debit-cell" : ""}">${r.debit>0 ? "‚Çπ" + formatNumber(r.debit) : "-"}</td>
      </tr>`;
  });

  merchantTable.innerHTML = html;
}

/* ----------------------------- */
/*        AI INSIGHT BOX         */
/* ----------------------------- */

function generateAIInsight(){
  const box = document.getElementById("aiInsight");
  box.style.display = "none";

  let totalCredit = 0, totalDebit = 0;
  const merchantTotals = {};
  let totalSpend = 0;

  filteredData.forEach(r=>{
    const m = getValue(r,"merchant name");
    const c = +getValue(r,"credit") || 0;
    const d = +getValue(r,"debit") || 0;
    totalCredit += c; totalDebit += d;
    if(m && d>0){
      merchantTotals[m] = (merchantTotals[m] || 0) + d;
      totalSpend += d;
    }
  });

  if(totalSpend === 0) return;

  let topMerchant = "", topAmount = 0;
  for(const m in merchantTotals){
    if(merchantTotals[m] > topAmount){
      topMerchant = m; topAmount = merchantTotals[m];
    }
  }

  const percent = ((topAmount / totalSpend) * 100).toFixed(1);
  const netSaving = totalCredit - totalDebit;

  // period text mirrors buildSummaryTitle logic
  let period = "Overall";
  if(yearFilter.value && monthFilter.value === ""){
    period = `${yearFilter.value} (All Months)`;
  } else if(!yearFilter.value && monthFilter.value !== ""){
    period = `${new Date(0,monthFilter.value).toLocaleString("en",{month:"long"})} (All Years)`;
  } else if(yearFilter.value && monthFilter.value !== ""){
    period = `${new Date(0,monthFilter.value).toLocaleString("en",{month:"long"})} ${yearFilter.value}`;
  }

  box.innerHTML = `
    üß† <b>AI Spending Insight</b><br><br>
    üìå In <b>${period}</b>, highest spending was on <b>${escapeHtml(String(topMerchant).toUpperCase())}</b> ‚Äî
    <b>‚Çπ${formatNumber(topAmount)}</b> <span style="color:#6b7280">(${percent}% of spending)</span><br><br>
    üí∞ <b>Net saving:</b> <span style="color:${netSaving>=0 ? '#16a34a' : '#dc2626'}; font-weight:600">
      ‚Çπ${formatNumber(netSaving)}
    </span><br><br>
    ${ percent > 40 ? "‚ö†Ô∏è This merchant dominates your expenses." :
       percent > 25 ? "üîç This is a major expense area." :
       "‚úÖ Spending is reasonably distributed." }
  `;

  box.style.display = "block";
}

/* ----------------------------- */
/*      SMALL UTILITIES          */
/* ----------------------------- */

function escapeHtml(text){
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

/* ----------------------------- */
/*     INITIAL EMPTY STATE       */
/* ----------------------------- */

(function initEmpty(){
  // ensure charts have some height so they render nicely
  document.getElementById("monthChart").style.height = "260px";
  document.getElementById("weeklyChart").style.height = "260px";
})();
</script>
</body>
</html>
