<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense & Savings Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f5f7fb;
  --card:#fff;
  --primary:#4f46e5;
  --success:#16a34a;
  --danger:#dc2626;
  --text:#1f2937;
  --muted:#6b7280;

  --glass-bg: rgba(255, 255, 255, 0.35);
  --glass-border: rgba(255, 255, 255, 0.55);
}

/* ---------------- GLOBAL ---------------- */

*{box-sizing:border-box}

body{
  margin:0;
  padding-top:95px;
  font-family:"Segoe UI",system-ui;
  background:var(--bg);
  color:var(--text);
}

/* ---------------- HEADER ---------------- */

header{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#fff;
  padding:26px;
  font-size:26px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;

  position:fixed;
  top:0; 
  left:0;
  width:100%;
  z-index:999;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}

/* Search bar */
.search-input{
  padding:12px 48px 12px 18px;
  border-radius:50px;
  border:2px solid #ececec;
  background:#ffffff;
  font-size:15px;
  width:320px;
  outline:none;
  transition:0.3s ease-in-out;
  box-shadow:0 3px 10px rgba(0,0,0,0.10);
}
.search-input:focus{
  width:360px;
  border-color:#4f46e5;
  box-shadow:0 6px 20px rgba(79,70,229,0.35);
}
.search-icon{
  position:absolute;
  right:18px;
  top:50%; transform:translateY(-50%);
  font-size:18px;
  pointer-events:none;
  color:#6b6b6b;
}

/* ---------------- GLASS FILTER PANEL ---------------- */

.controls {
  display:flex;
  gap:20px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:35px;

  padding:18px 28px;
  background: var(--glass-bg);
  border-radius:26px;
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1.6px solid var(--glass-border);

  box-shadow: 0 12px 32px rgba(0,0,0,0.12);
}

/* Improved dropdowns */
select{
  appearance:none;
  padding:14px 52px 14px 20px;
  min-width:180px;

  background:rgba(255,255,255,0.65);
  border:2px solid #e2e8f0;
  border-radius:18px;

  font-size:15px;
  font-weight:600;
  color:#374151;

  background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' stroke='%236366f1' stroke-width='2' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 18px center;
  background-size:18px;

  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  transition:0.22s ease;
  cursor:pointer;
}

select:hover{
  border-color:#6366f1;
  box-shadow:0 10px 26px rgba(79,70,229,0.25);
  transform:translateY(-2px);
}

select:focus{
  outline:none;
  border-color:#4f46e5;
  box-shadow:0 0 0 3px rgba(79,70,229,0.25);
}

/* Apply Filter Button (Glass + Gradient) */
.controls button{
  padding:14px 28px;
  font-size:15px;
  font-weight:600;
  color:white;

  background:linear-gradient(135deg,#4f46e5,#6366f1);
  border:none;
  border-radius:18px;

  box-shadow:0 12px 28px rgba(99,102,241,0.35);
  cursor:pointer;
  transition:0.25s ease;
}

.controls button:hover{
  transform:translateY(-3px) scale(1.03);
  box-shadow:0 18px 38px rgba(79,70,229,0.45);
}

.controls button:active{
  transform:scale(0.96);
}

/* ---------------- REST OF UI BELOW (unchanged) ---------------- */

.container{max-width:1200px;margin:20px auto;padding:20px}

/* Summary cards */
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:22px;margin-bottom:30px;
}

.card{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
}
.card h4{margin:0;color:var(--muted)}
.card h2{margin-top:12px;font-size:30px}
.credit h2{color:var(--success)}
.debit h2{color:var(--danger)}
.saving h2{color:var(--primary)}

/* Section boxes */
.section{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
  margin-bottom:30px;
}

/* Table */
table{width:100%;border-collapse:collapse;margin-top:16px}
th{background:#eef2ff;padding:12px;text-align:left}
td{padding:12px;border-bottom:1px solid #eee}

.table-row-highlight:hover{
  background:#f3f4f6; transition:0.2s;
}

.credit-cell { color:#16a34a;font-weight:600; }
.debit-cell { color:#dc2626;font-weight:600; }

/* Chart size fixes */
#monthChart, #weeklyChart {
  width:100%;
  max-height:400px !important;
  height:400px !important;
}

footer{text-align:center;color:var(--muted);padding:15px}

#filterLoader{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#filterLoader.show{display:flex;}
</style>
</head>
<body>

<header>
  <div>üìä Expense & Savings Dashboard</div>

  <div style="position:relative;">
    <input 
      type="text" 
      id="searchBar"
      class="search-input"
      placeholder="Search merchants..."
      oninput="debouncedMerchantSearch()"
    >
    <span class="search-icon">üîç</span>
  </div>
</header>

<div class="container">

<!-- ---------------- GLASS FILTER PANEL ---------------- -->
<div class="controls">
  <div class="upload-box" id="uploadBox" style="
    border:2px dashed #c7c9ff;
    padding:22px 30px;
    border-radius:18px;
    background:#eef2ff;
    cursor:pointer;
    min-width:280px;
    text-align:center;">
    
    <input type="file" id="fileInput" accept=".xls,.xlsx" hidden>
    <div class="upload-content" id="uploadContent">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">Drag & drop Excel file<br><span>or click to browse</span></div>
    </div>
    <div class="upload-status" id="uploadStatus"></div>
  </div>

  <select id="yearFilter"><option value="">All Years</option></select>
  <select id="monthFilter"><option value="">All Months</option></select>
  <button onclick="applyFilter()">Apply Filter</button>
</div>

<!-- ---------------- SUMMARY CARDS ---------------- -->
<div class="summary">
  <div class="card credit">
    <h4 id="creditTitle">Total Credit</h4>
    <h2 id="credit">‚Çπ0</h2>
  </div>

  <div class="card debit">
    <h4 id="debitTitle">Total Debit</h4>
    <h2 id="debit">‚Çπ0</h2>
  </div>

  <div class="card saving">
    <h4 id="savingTitle">Net Saving</h4>
    <h2 id="saving">‚Çπ0 <span id="savingArrow"></span></h2>
  </div>
</div>

<!-- ---------------- MONTH TABLE + CHART ---------------- -->
<div class="section">
  <h3>üìà Month-wise Savings Trend</h3>
  <table id="monthTable"></table>
  <canvas id="monthChart"></canvas>
</div>

<!-- ---------------- WEEKLY SPENDING ---------------- -->
<div class="section" id="weeklySection" style="display:none">
  <h3 id="weeklyTitle">üóì Weekly Spending</h3>
  <canvas id="weeklyChart"></canvas>
</div>

<!-- ---------------- MERCHANT TABLE ---------------- -->
<div class="section">
  <h3>üè™ Merchant-wise Spending (Full Transaction Log)</h3>

  <div id="aiInsight"
       style="background:#fef3c7;padding:16px;border-radius:14px;margin-bottom:18px;
              border-left:6px solid #f59e0b;font-size:15px;display:none;">
  </div>

  <table id="merchantTable"></table>
</div>

</div>

<footer>Built from your Excel data ‚Ä¢ Fully offline & secure</footer>

<div id="filterLoader"><div class="loader"></div></div>

<!-- ---------------- SCRIPT (UNCHANGED LOGIC) ---------------- -->
<script>

let rawData = [], filteredData = [], monthChart, weeklyChart;

/* --- Helpers --- */
function formatNumber(n){ return n.toLocaleString("en-IN",{ minimumFractionDigits: 2 }); }
function getValue(row, key){
  const match = Object.keys(row).find(k => k.trim().toLowerCase() === key.toLowerCase());
  return match ? row[match] : 0;
}
function parseDate(v){
  if(typeof v === "number"){
    return new Date((v - 25569) * 86400 * 1000);
  }
  const p = v.split("-");
  return new Date(p[2], p[1]-1, p[0]);
}

/* --- Search --- */
let searchTimeout = null;
function debouncedMerchantSearch(){
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(merchantSearch, 150);
}
function merchantSearch(){
  const q = document.getElementById("searchBar").value.toLowerCase();
  const rows = merchantTable.getElementsByTagName("tr");

  for(let i=1; i < rows.length; i++){
    const merchantCell = rows[i].getElementsByTagName("td")[1];

    const originalText =
      merchantCell.getAttribute("data-original") || merchantCell.innerText;

    if(!merchantCell.getAttribute("data-original")){
      merchantCell.setAttribute("data-original", originalText);
    }

    const name = originalText.toLowerCase();

    if(name.includes(q)){
      rows[i].style.display = "";

      if(q.trim() !== ""){
        const regex = new RegExp(`(${q})`, "ig");
        merchantCell.innerHTML = originalText.replace(regex, `<mark>$1</mark>`);
      } else {
        merchantCell.innerHTML = originalText;
      }

    } else {
      rows[i].style.display = "none";
      merchantCell.innerHTML = originalText;
    }
  }
}

/* --- File Upload --- */
uploadBox.onclick = () => fileInput.click();
["dragenter","dragover"].forEach(ev => {
  uploadBox.addEventListener(ev, e=>{
    e.preventDefault();
    uploadBox.classList.add("dragover");
  });
});
["dragleave","drop"].forEach(ev => {
  uploadBox.addEventListener(ev, e=>{
    e.preventDefault();
    uploadBox.classList.remove("dragover");
  });
});
uploadBox.addEventListener("drop", e=>{
  if(e.dataTransfer.files.length){
    loadExcel(e.dataTransfer.files[0]);
  }
});
fileInput.addEventListener("change", ()=>{
  if(fileInput.files.length){
    loadExcel(fileInput.files[0]);
  }
});

async function loadExcel(file){
  filterLoader.classList.add("show");
  uploadContent.innerHTML = '<div class="loader"></div>';
  uploadStatus.innerText = "Loading file...";

  await new Promise(r => setTimeout(r, 50));

  const reader = new FileReader();
  reader.onload = async e => {
    uploadStatus.innerText = "Processing data...";
    await new Promise(r => setTimeout(r, 100));

    const wb = XLSX.read(e.target.result, { type: "array" });
    rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    filteredData = rawData;

    await new Promise(r => setTimeout(r, 60));

    loadFilters();
    renderAll();

    uploadContent.innerHTML = '<div class="upload-icon">‚úÖ</div>';
    uploadStatus.innerHTML = `<span class="success">Loaded ${file.name}</span>`;
    filterLoader.classList.remove("show");
  };

  reader.readAsArrayBuffer(file);
}

/* --- Filter System --- */
function loadFilters(){
  const years = new Set(), months = new Set();

  rawData.forEach(r => {
    const d = parseDate(getValue(r,"date"));
    years.add(d.getFullYear());
    months.add(d.getMonth());
  });

  yearFilter.innerHTML = '<option value="">All Years</option>';
  [...years].sort().forEach(y => {
    yearFilter.innerHTML += `<option>${y}</option>`;
  });

  monthFilter.innerHTML = '<option value="">All Months</option>';
  [...months].sort().forEach(m => {
    monthFilter.innerHTML += `
      <option value="${m}">
        ${new Date(0,m).toLocaleString("en",{month:"long"})}
      </option>`;
  });
}

function applyFilter(){
  filterLoader.classList.add("show");

  setTimeout(() => {
    filteredData = rawData.filter(r => {
      const d = parseDate(getValue(r,"date"));
      return (!yearFilter.value || d.getFullYear() == yearFilter.value)
          && (!monthFilter.value || d.getMonth() == monthFilter.value);
    });

    renderAll();
    filterLoader.classList.remove("show");
  }, 200);
}

/* --- Summary --- */
function buildSummaryTitle(){
  let title = "Overall";

  if(yearFilter.value && monthFilter.value === ""){
    title = `${yearFilter.value} (All Months)`;
  }

  if(!yearFilter.value && monthFilter.value !== ""){
    const m = new Date(0, monthFilter.value).toLocaleString("en",{month:"long"});
    title = `${m} (All Years)`;
  }

  if(yearFilter.value && monthFilter.value !== ""){
    const m = new Date(0, monthFilter.value).toLocaleString("en",{month:"long"});
    title = `${m} ${yearFilter.value}`;
  }

  return title;
}

function totals(){
  let c = 0, d = 0;

  filteredData.forEach(r=>{
    c += +getValue(r,"credit") || 0;
    d += +getValue(r,"debit") || 0;
  });

  const net = c - d;

  credit.innerText = "‚Çπ" + formatNumber(c);
  debit.innerText  = "‚Çπ" + formatNumber(d);
  saving.childNodes[0].nodeValue = "‚Çπ" + formatNumber(net) + " ";

  const title = buildSummaryTitle();
  creditTitle.innerText = `Total Credit ‚Äì ${title}`;
  debitTitle.innerText  = `Total Debit ‚Äì ${title}`;
  savingTitle.innerText = `Net Saving ‚Äì ${title}`;

  if(net > 0){
    savingArrow.innerHTML = `
      <svg width="26" height="26" stroke="#16a34a" stroke-width="2.8" fill="none" viewBox="0 0 24 24">
        <path d="M12 19V5"/><path d="M5 12l7-7 7 7"/>
      </svg>`;
  } 
  else if(net < 0){
    savingArrow.innerHTML = `
      <svg width="26" height="26" stroke="#dc2626" stroke-width="2.8" fill="none" viewBox="0 0 24 24">
        <path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/>
      </svg>`;
  }
}

/* --- Renderer --- */
function renderAll(){
  totals();
  setTimeout(monthWise, 30);
  setTimeout(weeklyWise, 60);
  setTimeout(merchantWise, 100);
  setTimeout(generateAIInsight, 140);
}

/* --- Month-wise --- */
function monthWise(){
  const map = {};
  filteredData.forEach(r=>{
    const d = parseDate(getValue(r,"date"));
    const key = d.getMonth() + "-" + d.getFullYear();
    if(!map[key]) map[key] = { c:0, d:0, date: d };
    map[key].c += +getValue(r,"credit") || 0;
    map[key].d += +getValue(r,"debit") || 0;
  });

  monthTable.innerHTML = '<tr><th>Month</th><th>Credit</th><th>Debit</th><th>Saving</th></tr>';

  const labels = [], vals = [];
  Object.values(map)
    .sort((a,b) => a.date - b.date)
    .forEach(v => {
      const s = v.c - v.d;
      const lab = v.date.toLocaleString("en",{month:"short", year:"numeric"});

      monthTable.innerHTML += `
        <tr>
          <td>${lab}</td>
          <td>${formatNumber(v.c)}</td>
          <td>${formatNumber(v.d)}</td>
          <td>${formatNumber(s)}</td>
        </tr>`;

      labels.push(lab);
      vals.push(s);
    });

  if(monthChart) monthChart.destroy();
  monthChart = new Chart(document.getElementById("monthChart"), {
    type:"line",
    data:{
      labels:labels,
      datasets:[{
        label:"Net Saving",
        data:vals,
        borderWidth:3,
        tension:0.35
      }]
    },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

/* --- Weekly chart --- */
function weeklyWise(){
  if(monthFilter.value === ""){
    weeklySection.style.display = "none";
    return;
  }
  weeklySection.style.display = "block";

  const weeks = [0,0,0,0,0];
  filteredData.forEach(r=>{
    const d = parseDate(getValue(r,"date"));
    const deb = +getValue(r,"debit") || 0;
    if(deb > 0){
      const w = Math.min(Math.floor((d.getDate()-1)/7), 4);
      weeks[w] += deb;
    }
  });

  if(weeklyChart) weeklyChart.destroy();
  weeklyChart = new Chart(document.getElementById("weeklyChart"), {
    type:"line",
    data:{
      labels:["Week 1","Week 2","Week 3","Week 4","Week 5"],
      datasets:[{
        label:"Weekly Spending",
        data:weeks,
        borderWidth:3,
        tension:0.35
      }]
    },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

/* --- Merchant table --- */
function merchantWise(){
  const rows = [];

  filteredData.forEach(r=>{
    const d = parseDate(getValue(r,"date"));
    rows.push({
      date: d,
      dateLabel: d.toLocaleDateString("en-GB",{day:"2-digit", month:"short", year:"numeric"}),
      merchant: getValue(r,"merchant name"),
      credit: +getValue(r,"credit") || 0,
      debit: +getValue(r,"debit") || 0
    });
  });

  rows.sort((a,b) => a.date - b.date);

  let html = `
    <tr>
      <th>Date</th>
      <th>Merchant</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>`;

  rows.forEach(r=>{
    const merchantSafe = (r.merchant && String(r.merchant)) || "-";
    html += `
      <tr class="table-row-highlight">
        <td>${r.dateLabel}</td>
        <td data-original="${escapeHtml(merchantSafe)}">${escapeHtml(merchantSafe)}</td>
        <td class="${r.credit>0 ? "credit-cell" : ""}">${r.credit>0 ? "‚Çπ" + formatNumber(r.credit) : "-"}</td>
        <td class="${r.debit>0 ? "debit-cell" : ""}">${r.debit>0 ? "‚Çπ" + formatNumber(r.debit) : "-"}</td>
      </tr>`;
  });

  merchantTable.innerHTML = html;
}

/* --- AI Insight --- */
function generateAIInsight(){
  const box = document.getElementById("aiInsight");
  box.style.display = "none";

  let totalCredit = 0, totalDebit = 0;
  const merchantTotals = {};
  let totalSpend = 0;

  filteredData.forEach(r=>{
    const m = getValue(r,"merchant name");
    const c = +getValue(r,"credit") || 0;
    const d = +getValue(r,"debit") || 0;
    totalCredit += c; totalDebit += d;
    if(m && d>0){
      merchantTotals[m] = (merchantTotals[m] || 0) + d;
      totalSpend += d;
    }
  });

  if(totalSpend === 0) return;

  let topMerchant = "", topAmount = 0;
  for(const m in merchantTotals){
    if(merchantTotals[m] > topAmount){
      topMerchant = m; topAmount = merchantTotals[m];
    }
  }

  const percent = ((topAmount / totalSpend) * 100).toFixed(1);
  const netSaving = totalCredit - totalDebit;

  let period = buildSummaryTitle();

  box.innerHTML = `
    üß† <b>AI Spending Insight</b><br><br>
    üìå In <b>${period}</b>, highest spending was on <b>${escapeHtml(String(topMerchant).toUpperCase())}</b> ‚Äî
    <b>‚Çπ${formatNumber(topAmount)}</b> <span style="color:#6b7280">(${percent}% of spending)</span><br><br>
    üí∞ <b>Net saving:</b> 
    <span style="color:${netSaving>=0 ? '#16a34a' : '#dc2626'}; font-weight:600">
      ‚Çπ${formatNumber(netSaving)}
    </span><br><br>
    ${ percent > 40 ? "‚ö†Ô∏è This merchant dominates your expenses." :
       percent > 25 ? "üîç This is a major expense area." :
       "‚úÖ Spending is reasonably distributed." }
  `;

  box.style.display = "block";
}

/* --- Escape HTML --- */
function escapeHtml(text){
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

/* --- Initial Chart Heights --- */
(function initEmpty(){
  document.getElementById("monthChart").style.height = "400px";
  document.getElementById("weeklyChart").style.height = "400px";
})();
</script>

</body>
</html>
