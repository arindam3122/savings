<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense & Savings Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


<style>
:root{
  --bg:#f5f7fb;
  --card:#fff;
  --primary:#4f46e5;
  --success:#16a34a;
  --danger:#dc2626;
  --text:#1f2937;
  --muted:#6b7280;

  --glass-bg: rgba(255, 255, 255, 0.35);

}

/* ---------------- GLOBAL ---------------- */

*{box-sizing:border-box}

body{
  margin:0;
  padding-top:95px;
  font-family:"Segoe UI",system-ui;
  background:var(--bg);
  color:var(--text);
}

/* ---------------- HEADER ---------------- */

header{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#fff;
  padding:26px;
  font-size:26px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;

  position:fixed;
  top:0; 
  left:0;
  width:100%;
  z-index:999;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}

/* Search bar */
.search-input{
  padding:12px 48px 12px 18px;
  border-radius:50px;
  border:2px solid #ececec;
  background:#ffffff;
  font-size:15px;
  width:320px;
  outline:none;
  transition:0.3s ease-in-out;
  box-shadow:0 3px 10px rgba(0,0,0,0.10);
}
.search-input:focus{
  width:360px;
  border-color:#4f46e5;
  box-shadow:0 6px 20px rgba(79,70,229,0.35);
}
.search-icon{
  position:absolute;
  right:18px;
  top:50%; transform:translateY(-50%);
  font-size:18px;
  pointer-events:none;
  color:#6b6b6b;
}

/* ---------------- GLASS FILTER PANEL ---------------- */

.controls {
  display:flex;
  gap:20px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:35px;

  padding:18px 28px;
  background: var(--glass-bg);
  border-radius:26px;
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1.6px solid var(--glass-border);

  box-shadow: 0 12px 32px rgba(0,0,0,0.12);
}

/* Improved dropdowns */
select{
  appearance:none;
  padding:14px 52px 14px 20px;
  min-width:180px;

  background:rgba(255,255,255,0.65);
  border:2px solid #e2e8f0;
  border-radius:18px;

  font-size:15px;
  font-weight:600;
  color:#374151;

  background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' stroke='%236366f1' stroke-width='2' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 18px center;
  background-size:18px;

  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  transition:0.22s ease;
  cursor:pointer;
}

select:hover{
  border-color:#6366f1;
  box-shadow:0 10px 26px rgba(79,70,229,0.25);
  transform:translateY(-2px);
}

select:focus{
  outline:none;
  border-color:#4f46e5;
  box-shadow:0 0 0 3px rgba(79,70,229,0.25);
}

/* Apply Filter Button (Glass + Gradient) */
.controls button{
  padding:14px 28px;
  font-size:15px;
  font-weight:600;
  color:white;

  background:linear-gradient(135deg,#4f46e5,#6366f1);
  border:none;
  border-radius:18px;

  box-shadow:0 12px 28px rgba(99,102,241,0.35);
  cursor:pointer;
  transition:0.25s ease;
}

.controls button:hover{
  transform:translateY(-3px) scale(1.03);
  box-shadow:0 18px 38px rgba(79,70,229,0.45);
}

.controls button:active{
  transform:scale(0.96);
}

/* ---------------- REST OF UI BELOW (unchanged) ---------------- */

.container{max-width:1200px;margin:20px auto;padding:20px}

/* Summary cards */
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:22px;margin-bottom:30px;
}

.card{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
}
.card h4{margin:0;color:var(--muted)}
.card h2{margin-top:12px;font-size:30px}
.credit h2{color:var(--success)}
.debit h2{color:var(--danger)}
.saving h2{color:var(--primary)}

/* Section boxes */
.section{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.08);
  margin-bottom:30px;
}

/* Table */
table{width:100%;border-collapse:collapse;margin-top:16px}
th{background:#eef2ff;padding:12px;text-align:left}
td{padding:12px;border-bottom:1px solid #eee}

.table-row-highlight:hover{
  background:#f3f4f6; transition:0.2s;
}
.month-row-hover:hover {
  background: #f3f4f6;
  transition: 0.25s ease;
}

.credit-cell { color:#16a34a;font-weight:600; }
.debit-cell { color:#dc2626;font-weight:600; }

/* Chart size fixes */
#monthChart, #weeklyChart {
  width:100%;
  max-height:400px !important;
  height:400px !important;
}

footer{text-align:center;color:var(--muted);padding:15px}

#filterLoader{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#filterLoader.show{display:flex;}
/* Smooth fade + slide animation */
@keyframes fadeSlideUp {
  0% {
    opacity: 0;
    transform: translateY(20px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}
/* Spinner for Excel loading + Filter loading */
#filterLoader .loader {
  width: 55px;
  height: 55px;
  border: 6px solid #dcdcff;
  border-top-color: #4f46e5;
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}
#filterLoader {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(6px);
}

/* Apply to major UI blocks */
.section,
.summary .card,
.controls,
header,

.card, .section {
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.card:hover, .section:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 40px rgba(0,0,0,0.12);
}
/* Month table hover highlight */
#monthTable tr:hover {
  background: #f3f4f6;
  transition: 0.25s ease;
}

/* Fullscreen loader */
#pageLoader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 5000;
}

/* Spinner animation */
.spinner {
  width: 55px;
  height: 55px;
  border: 6px solid #e0e0ff;
  border-top-color: #4f46e5;
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}

@keyframes spin {
  100% {
    transform: rotate(360deg);
  }
}

/* Smooth fade-out of loader */
#pageLoader.fade-out {
  opacity: 0;
  transition: opacity 0.5s ease;
  pointer-events: none;
}
.month-credit {
  color: #16a34a;
  font-weight: 600;
}

.month-debit {
  color: #dc2626;
  font-weight: 600;
}

.month-saving-positive {
  color: #16a34a; /* GREEN */
  font-weight: 700;
}

.month-saving-negative {
  color: #dc2626; /* RED */
  font-weight: 700;
}

.saving-arrow {
  display: inline-flex;
  align-items: center;
  margin-left: 6px;
}

.saving-arrow svg {
  width: 16px;
  height: 16px;
}
/* Upload toast (success + error) */
#uploadToast {
  position: fixed;
  bottom: 24px;
  left: 24px;
  padding: 14px 22px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  color: #ffffff;
  box-shadow: 0 14px 32px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateY(20px);
  pointer-events: none;
  transition: all .35s ease;
  z-index: 4000;
  max-width: 340px;
}

/* Success */
#uploadToast.success {
  background: #008d34;
}

/* Error */
#uploadToast.error {
  background: #dc2626;
}

/* Visible */
#uploadToast.show {
  opacity: 1;
  transform: translateY(0);
}
/* Merchant Date Filter */
.date-filter {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: flex-end;
  margin-bottom: 14px;
}

.date-filter input[type="date"] {
  padding: 10px 14px;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  font-size: 14px;
  background: #ffffff;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: 0.25s ease;
}

.date-filter input[type="date"]:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79,70,229,0.25);
}

.date-filter button {
  padding: 10px 18px;
  border-radius: 12px;
  border: none;
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  background: linear-gradient(135deg,#4f46e5,#6366f1);
  cursor: pointer;
  box-shadow: 0 10px 22px rgba(79,70,229,0.35);
  transition: 0.25s ease;
}

.date-filter button:hover {
  transform: translateY(-2px);
}

.date-filter button.reset {
  background: #6b7280;
  box-shadow: 0 8px 18px rgba(107,114,128,0.35);
}
.flatpickr-input {
  padding: 10px 14px;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  font-size: 14px;
  background: #ffffff;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}
/* Calendar input field */
#dateFilter,
.flatpickr-input {
  width: 160px;
  padding: 10px 40px 10px 14px;
  border-radius: 14px;
  border: 2px solid #e5e7eb;
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
  background: #ffffff;
  cursor: pointer;

  /* subtle depth */
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);

  /* smooth interaction */
  transition: all 0.25s ease;
}

/* Hover effect */
#dateFilter:hover {
  border-color: #6366f1;
  box-shadow: 0 10px 26px rgba(79, 70, 229, 0.25);
  transform: translateY(-1px);
}

/* Focus / active */
#dateFilter:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
}

/* Calendar icon (right side) */
#dateFilter {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='none' stroke='%236366f1' stroke-width='2' viewBox='0 0 24 24'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'/%3E%3Cline x1='16' y1='2' x2='16' y2='6'/%3E%3Cline x1='8' y1='2' x2='8' y2='6'/%3E%3Cline x1='3' y1='10' x2='21' y2='10'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 18px;
}

/* Disabled state (if ever needed) */
#dateFilter:disabled {
  background-color: #f3f4f6;
  color: #9ca3af;
  cursor: not-allowed;
  box-shadow: none;
}
/* ---------- TABLE SHIMMER LOADER ---------- */
.shimmer-row td {
  height: 18px;
  border-radius: 8px;
  background: linear-gradient(
    90deg,
    #f1f5f9 25%,
    #e5e7eb 37%,
    #f1f5f9 63%
  );
  background-size: 400% 100%;
  animation: shimmer 1.2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { background-position: 100% 0; }
  100% { background-position: -100% 0; }
}
/* ---------- TABLE SPINNER ---------- */
.table-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px 0;
}

.table-spinner .spinner {
  width: 34px;
  height: 34px;
  border: 4px solid #e5e7eb;
  border-top-color: #4f46e5;
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}
/* ---------- Transaction Count Badge ---------- */
#transactionCount {
  padding: 14px 18px;
  margin: 14px 0 20px;

  font-size: 15px;
  font-weight: 700;

  color: #065f46;
  background: #ecfdf5;

  border-left: 6px solid #10b981;
  border-radius: 12px;

  box-shadow: 0 10px 24px rgba(16,185,129,0.25);
}
/* Highlight rows with no credit & no debit */
/* Attractive highlight for missing credit & debit */
.missing-amount {
  background: linear-gradient(
    90deg,
    #fff7ed 0%,
    #ffedd5 100%
  );
  color: #9a3412;
  font-weight: 700;

  border-left: 6px solid #fb923c;
  border-radius: 8px;

  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 8px;

  box-shadow: inset 0 0 0 1px rgba(251,146,60,0.25);
}

/* Warning icon badge */
.missing-amount::before {
  content: "‚ö†Ô∏è";
  font-size: 16px;
}

/* Smooth hover effect */
tr:hover .missing-amount {
  background: linear-gradient(
    90deg,
    #ffedd5 0%,
    #fed7aa 100%
  );
  transform: translateX(3px);
  transition: all 0.25s ease;
}
tr:has(.missing-amount) {
  background: #fffaf0;
}

tr:has(.missing-amount):hover {
  background: #fff3e0;
}
#totals-bar {
  display: flex;
  gap: 18px;
  margin-bottom: 18px;
}

.total-box {
  padding: 10px 18px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 15px;
}

.sells {
  background: #ecfdf5;
  color: #047857;
}

.expense {
  background: #fef2f2;
  color: #b91c1c;
}
#resetFilterBtn {
  padding: 14px 26px;
  font-size: 15px;
  font-weight: 600;
  color: #374151;
  background: #e5e7eb;
  border: none;
  border-radius: 18px;
  cursor: pointer;
  transition: 0.25s ease;
}

#resetFilterBtn:hover {
  background: #d1d5db;
  transform: translateY(-2px);
}
/* RESET FILTER BUTTON */
#resetFilterBtn {
  padding: 14px 26px;
  font-size: 15px;
  font-weight: 600;

  border-radius: 18px;
  border: none;
  cursor: pointer;

  background: linear-gradient(135deg, #e5e7eb, #d1d5db);
  color: #6b7280;

  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  transition: all 0.25s ease;
}

/* Enabled state */
#resetFilterBtn:not(:disabled) {
  background: linear-gradient(135deg, #4f46e5, #6366f1);
  color: #ffffff;
  box-shadow: 0 12px 28px rgba(79,70,229,0.45);
}

/* Hover only when enabled */
#resetFilterBtn:not(:disabled):hover {
  transform: translateY(-3px) scale(1.03);
  box-shadow: 0 18px 38px rgba(79,70,229,0.55);
}

/* Disabled state */
#resetFilterBtn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  box-shadow: none;
}

</style>
</head>
<body>
<div id="pageLoader">
  <div class="spinner"></div>
</div>

<header>
  <div>üìä Expense & Savings Dashboard</div>

 <div style="position:relative;">
  <input 
    type="text" 
    id="searchBar"
    class="search-input"
    placeholder="Search merchants..."
    oninput="debouncedMerchantSearch()"
  >

  <!-- ‚ùå Clear search -->
 <span 
  id="clearSearch"
  onclick="clearSearch()"
  style="
    position:absolute;
    right:42px;
    top:50%;
    transform:translateY(-50%);
    font-size:18px;
    cursor:pointer;
    color:#dc2626;           /* RED */
    display:none;
    transition:0.2s;
  "
  onmouseover="this.style.color='#b91c1c'"
  onmouseout="this.style.color='#dc2626'"
 >‚úñ</span>


  <span class="search-icon">üîç</span>
</div>

</header>

<div class="container">

<!-- ---------------- GLASS FILTER PANEL ---------------- -->
<div class="controls">
  <div class="upload-box" id="uploadBox" style="
    border:2px dashed #c7c9ff;
    padding:22px 30px;
    border-radius:18px;
    background:#eef2ff;
    cursor:pointer;
    min-width:280px;
    text-align:center;">
    
    <input type="file" id="fileInput" accept=".xls,.xlsx" hidden>
    <div class="upload-content" id="uploadContent">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">Drag & drop Excel file<br><span>or click to browse</span></div>
    </div>
    <div class="upload-status" id="uploadStatus"></div>
  </div>

  <select id="yearFilter"><option value="">All Years</option></select>
  <select id="monthFilter"><option value="">All Months</option></select>
  <button 
  id="resetFilterBtn" 
  onclick="resetFilters()" 
  disabled
 >
  Reset Filter
</button>

</div>

<!-- ---------------- SUMMARY CARDS ---------------- -->
<div class="summary">
  <div class="card credit">
    <h4 id="creditTitle">Total Credit</h4>
    <h2 id="credit">‚Çπ0</h2>
  </div>

  <div class="card debit">
    <h4 id="debitTitle">Total Debit</h4>
    <h2 id="debit">‚Çπ0</h2>
  </div>

  <div class="card saving">
    <h4 id="savingTitle">Net Saving</h4>
    <h2 id="saving">‚Çπ0 <span id="savingArrow"></span></h2>
  </div>
</div>

<!-- ---------------- MONTH TABLE + CHART ---------------- -->
<div class="section">
  <h3>üìà Month-wise Savings Trend</h3>
  <table id="monthTable"></table>
  <canvas id="monthChart"></canvas>
</div>

<!-- ---------------- WEEKLY SPENDING ---------------- -->
<div class="section" id="weeklySection" style="display:none">
  <h3 id="weeklyTitle">üóì Weekly Spending</h3>
  <canvas id="weeklyChart"></canvas>
</div>

<!-- ---------------- MERCHANT TABLE ---------------- -->
<div class="section">
  <h3>üè™ Merchant-wise Spending (Full Transaction Log)</h3>
 <!-- Date Filter -->
 <div class="date-filter">
  <div id="transactionCount"
     style="
       margin: 10px 0 14px;
       font-weight: 600;
       color: #4f46e5;
       display: none;
     ">
 </div>

  <input type="text" id="dateFilter" placeholder="Select date" readonly>
  <button class="reset" onclick="resetDateFilter()">Reset</button>
 </div>


  <div id="aiInsight"
       style="background:#fef3c7;padding:16px;border-radius:14px;margin-bottom:18px;
              border-left:6px solid #f59e0b;font-size:15px;display:none;">
  </div>
  <div id="totals-bar" style="display:none">
  <div class="total-box sells">
    Total Sells: ‚Çπ<span id="totalSells">0</span>
  </div>

  <div class="total-box expense">
    Total Expenditure: ‚Çπ<span id="totalExpense">0</span>
  </div>
 </div>

  <table id="merchantTable"></table>
  <div 
  id="noSearchResult"
  style="
    display:none;
    text-align:center;
    padding:24px;
    color:#6b7280;
    font-weight:600;
  "
>
  ‚ùå No matching transactions found
</div>

</div>

<footer>Built from your Excel data ‚Ä¢ Fully offline & secure</footer>

<div id="filterLoader"><div class="loader"></div></div>

<!-- ---------------- SCRIPT (UNCHANGED LOGIC) ---------------- -->
<script>

let rawData = [], filteredData = [], monthChart, weeklyChart;

/* ================= AUTO FILTER SETUP ================= */

// Disable month until year is selected
monthFilter.disabled = true;

// Auto apply filter when year/month changes
yearFilter.addEventListener("change", autoApplyFilter);
monthFilter.addEventListener("change", autoApplyFilter);

function autoApplyFilter() {

  // If year is cleared ‚Üí DO NOTHING (wait for reset button)
  if (!yearFilter.value) {
    monthFilter.disabled = true;
    return;
  }

  // Enable month when year selected
  monthFilter.disabled = false;

  // Apply filter only when both selected
  if (yearFilter.value && monthFilter.value !== "") {
    applyFilter();
  }
}

function resetFilters() {
  yearFilter.value = "";
  monthFilter.value = "";
  monthFilter.disabled = true;

  filteredData = rawData;

  renderAll();
  initDatePicker();
  syncDatePickerLimits();

  showToast("üîÑ Filters reset ‚Äî showing all months", "success");
}


/* --- Helpers --- */
function formatNumber(n){ return n.toLocaleString("en-IN",{ minimumFractionDigits: 2 }); }
function getValue(row, key){
  const match = Object.keys(row).find(k => k.trim().toLowerCase() === key.toLowerCase());
  return match ? row[match] : 0;
}
function parseDate(v){
  if(typeof v === "number"){
    return new Date((v - 25569) * 86400 * 1000);
  }
  const p = v.split("-");
  return new Date(p[2], p[1]-1, p[0]);
}
function showTableSpinner() {
  merchantTable.innerHTML = `
    <tr>
      <td colspan="4">
        <div class="table-spinner">
          <div class="spinner"></div>
        </div>
      </td>
    </tr>
  `;
}

/* --- Search --- */
let searchTimeout = null;
function debouncedMerchantSearch(){
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(merchantSearch, 150);
}
function merchantSearch(){
  const q = document.getElementById("searchBar").value.toLowerCase();
  const rows = merchantTable.getElementsByTagName("tr");
  const clearBtn = document.getElementById("clearSearch");

  // show / hide ‚ùå button
  clearBtn.style.display = q ? "block" : "none";

  let visibleCount = 0;

  for(let i = 1; i < rows.length; i++){
    const merchantCell = rows[i].getElementsByTagName("td")[1];

    const originalText =
      merchantCell.getAttribute("data-original") || merchantCell.innerText;

    if(!merchantCell.getAttribute("data-original")){
      merchantCell.setAttribute("data-original", originalText);
    }

    const name = originalText.toLowerCase();

    if(name.includes(q)){
      rows[i].style.display = "";
      visibleCount++;

      if(q.trim()){
        const regex = new RegExp(`(${q})`, "ig");
        merchantCell.innerHTML = originalText.replace(regex, `<mark>$1</mark>`);
      } else {
        merchantCell.innerHTML = originalText;
      }
    } else {
      rows[i].style.display = "none";
      merchantCell.innerHTML = originalText;
    }
  }

  showNoSearchResult(visibleCount);
}

function showTableShimmer(rows = 6) {
  let html = `
    <tr>
      <th>Date</th>
      <th>Merchant</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>
  `;

  for (let i = 0; i < rows; i++) {
    html += `
      <tr class="shimmer-row">
        <td></td><td></td><td></td><td></td>
      </tr>
    `;
  }

  merchantTable.innerHTML = html;
}

/* --- File Upload --- */
uploadBox.onclick = () => fileInput.click();
["dragenter","dragover"].forEach(ev => {
  uploadBox.addEventListener(ev, e=>{
    e.preventDefault();
    uploadBox.classList.add("dragover");
  });
});
["dragleave","drop"].forEach(ev => {
  uploadBox.addEventListener(ev, e=>{
    e.preventDefault();
    uploadBox.classList.remove("dragover");
  });
});
uploadBox.addEventListener("drop", e=>{
  if(e.dataTransfer.files.length){
    loadExcel(e.dataTransfer.files[0]);
  }
});
fileInput.addEventListener("change", ()=>{
  if(fileInput.files.length){
    loadExcel(fileInput.files[0]);
  }
});

async function loadExcel(file){
  filterLoader.classList.add("show");
  uploadContent.innerHTML = '<div class="loader"></div>';
  uploadStatus.innerText = "Loading file...";

  await new Promise(r => setTimeout(r, 50));

  const reader = new FileReader();
  reader.onload = async e => {
    uploadStatus.innerText = "Processing data...";
    await new Promise(r => setTimeout(r, 100));

    const wb = XLSX.read(e.target.result, { type: "array" });
    rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    filteredData = rawData;

    await new Promise(r => setTimeout(r, 60));

    loadFilters();
    renderAll();
    initDatePicker();
    syncDatePickerLimits();

    uploadContent.innerHTML = '<div class="upload-icon">‚úÖ</div>';
    uploadStatus.innerHTML = `<span class="success">Loaded ${file.name}</span>`;
    filterLoader.classList.remove("show");
    showToast(`‚úÖ ${file.name} uploaded successfully`, "success");
    document.getElementById("resetFilterBtn").disabled = false;
  };

  reader.readAsArrayBuffer(file);
}
let datePicker;

function initDatePicker() {
  document.getElementById("aiInsight").style.display = "none";
  // Destroy old picker (important when filters change)
  if (datePicker) {
    datePicker.destroy();
  }

  // Get all valid transaction dates
  const validDates = [
    ...new Set(
      filteredData.map(r => {
        const d = parseDate(getValue(r, "date"));
        return d.toISOString().split("T")[0];
      })
    )
  ];

  // Initialize Flatpickr
  datePicker = flatpickr("#dateFilter", {
    dateFormat: "Y-m-d",
    enable: validDates,     // ‚úÖ ONLY THESE DATES ARE CLICKABLE
    disableMobile: true,
    onChange: function () {
      applyDateFilter();
    }
  });
}

/* --- Filter System --- */
function loadFilters(){
  const years = new Set(), months = new Set();

  rawData.forEach(r => {
    const d = parseDate(getValue(r,"date"));
    years.add(d.getFullYear());
    months.add(d.getMonth());
  });

  yearFilter.innerHTML = '<option value="">All Years</option>';
  [...years].sort().forEach(y => {
    yearFilter.innerHTML += `<option>${y}</option>`;
  });

  monthFilter.innerHTML = '<option value="">All Months</option>';
  [...months].sort().forEach(m => {
    monthFilter.innerHTML += `
      <option value="${m}">
        ${new Date(0,m).toLocaleString("en",{month:"long"})}
      </option>`;
  });
}
/*-----Filter functions-------*/
function applyDateFilter() {
  const selectedDate = document.getElementById("dateFilter").value;
  if (!selectedDate) return;

  // Hide previous AI insight (avoid overlap)
  document.getElementById("aiInsight").style.display = "none";

  // Show table spinner
  showTableSpinner();

  setTimeout(() => {
    const [year, month, day] = selectedDate.split("-").map(Number);
    const countBox = document.getElementById("transactionCount");

    // Filter transactions for selected date
    const result = filteredData.filter(r => {
      const d = parseDate(getValue(r, "date"));
      return (
        d.getFullYear() === year &&
        d.getMonth() === month - 1 &&
        d.getDate() === day
      );
    });

    /* ---------- SHOW TRANSACTION COUNT ---------- */
    countBox.style.display = "block";
    countBox.innerText =
      `üìå ${result.length} transaction${result.length !== 1 ? "s" : ""} recorded on ${day}/${month}/${year}`;

    /* ---------- NO DATA CASE ---------- */
    if (result.length === 0) {
      merchantTable.innerHTML = `
        <tr>
          <td colspan="4" style="
            text-align:center;
            padding:26px;
            color:#6b7280;
            font-weight:600;
          ">
            ‚ùå No transactions found for this date
          </td>
        </tr>
      `;

      showToast("‚ö†Ô∏è No data for selected date", "error");
      return;
    }

    /* ---------- RENDER TABLE ---------- */
    merchantWiseWithData(result);
    // Show totals bar
    document.getElementById("totals-bar").style.display = "flex";

// Refresh totals for selected date
calculateTotals();


    /* ---------- DATE-BASED AI INSIGHT ---------- */
    generateAIInsightFromData(
      result,
      `Spending insight for ${day}/${month}/${year}`
    );

    showToast(`üìÖ Showing transactions for ${day}/${month}/${year}`, "success");

  }, 250); // Smooth UX delay
}


document.getElementById("transactionCount").style.display = "none";
function resetDateFilter() {
  document.getElementById("dateFilter").value = "";
  document.getElementById("transactionCount").style.display = "none";
  document.getElementById("aiInsight").style.display = "none";

  filteredData = rawData.filter(r => {
    const d = parseDate(getValue(r, "date"));
    return (!yearFilter.value || d.getFullYear() == yearFilter.value)
        && (!monthFilter.value || d.getMonth() == monthFilter.value);
  });

  renderAll();
  initDatePicker();
  syncDatePickerLimits();

  showToast("üîÑ Date filter reset ‚Äî showing all transactions", "success");
  // Hide totals bar on reset
 document.getElementById("totals-bar").style.display = "none";

}

 function applyFilter(){
  filterLoader.classList.add("show");

  setTimeout(() => {
    filteredData = rawData.filter(r => {
      const d = parseDate(getValue(r,"date"));
      return (!yearFilter.value || d.getFullYear() == yearFilter.value)
          && (!monthFilter.value || d.getMonth() == monthFilter.value);
    });

    renderAll();
    initDatePicker();
    syncDatePickerLimits(); // ‚úÖ ADD THIS LINE
    filterLoader.classList.remove("show");

    showToast(getFilterToastMessage(), "success");
  }, 200);
}


/* --- Summary --- */
function buildSummaryTitle(){
  let title = "Overall";

  if(yearFilter.value && monthFilter.value === ""){
    title = `${yearFilter.value} (All Months)`;
  }

  if(!yearFilter.value && monthFilter.value !== ""){
    const m = new Date(0, monthFilter.value).toLocaleString("en",{month:"long"});
    title = `${m} (All Years)`;
  }

  if(yearFilter.value && monthFilter.value !== ""){
    const m = new Date(0, monthFilter.value).toLocaleString("en",{month:"long"});
    title = `${m} ${yearFilter.value}`;
  }

  return title;
}

function totals(){
  let c = 0, d = 0;

  filteredData.forEach(r=>{
    c += +getValue(r,"credit") || 0;
    d += +getValue(r,"debit") || 0;
  });

  const net = c - d;

  credit.innerText = "‚Çπ" + formatNumber(c);
  debit.innerText  = "‚Çπ" + formatNumber(d);
  saving.childNodes[0].nodeValue = "‚Çπ" + formatNumber(net) + " ";

  const title = buildSummaryTitle();
  creditTitle.innerText = `Total Credit ‚Äì ${title}`;
  debitTitle.innerText  = `Total Debit ‚Äì ${title}`;
  savingTitle.innerText = `Net Saving ‚Äì ${title}`;

  if(net > 0){
    savingArrow.innerHTML = `
      <svg width="26" height="26" stroke="#16a34a" stroke-width="2.8" fill="none" viewBox="0 0 24 24">
        <path d="M12 19V5"/><path d="M5 12l7-7 7 7"/>
      </svg>`;
  } 
  else if(net < 0){
    savingArrow.innerHTML = `
      <svg width="26" height="26" stroke="#dc2626" stroke-width="2.8" fill="none" viewBox="0 0 24 24">
        <path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/>
      </svg>`;
  }
}
function getFilterToastMessage() {
  const year = yearFilter.value;
  const month = monthFilter.value;

  if (!year && !month) {
    return "üîÑ Filters reset ‚Äî showing all data";
  }

  if (year && !month) {
    return `‚úÖ Filter applied: ${year} (All Months)`;
  }

  if (!year && month) {
    const m = new Date(0, month).toLocaleString("en", { month: "long" });
    return `‚úÖ Filter applied: ${m} (All Years)`;
  }

  const m = new Date(0, month).toLocaleString("en", { month: "long" });
  return `‚úÖ Filter applied: ${m} ${year}`;
}

/* --- Renderer --- */
function renderAll(){
  totals();
  setTimeout(monthWise, 30);
  setTimeout(weeklyWise, 60);
  setTimeout(merchantWise, 100);
  setTimeout(generateAIInsight, 140);
}
function clearSearch() {
  const input = document.getElementById("searchBar");
  input.value = "";
  merchantSearch();
  document.getElementById("clearSearch").style.display = "none";
}

function showNoSearchResult(count) {
  const box = document.getElementById("noSearchResult");
  box.style.display = count === 0 ? "block" : "none";
}

/* --- Month-wise --- */
function monthWise() {
  const map = {};

  // Aggregate month-wise credit & debit
  filteredData.forEach(r => {
    const d = parseDate(getValue(r, "date"));
    const key = d.getMonth() + "-" + d.getFullYear();

    if (!map[key]) {
      map[key] = {
        credit: 0,
        debit: 0,
        date: d
      };
    }

    map[key].credit += +getValue(r, "credit") || 0;
    map[key].debit  += +getValue(r, "debit") || 0;
  });

  // Build table header
  monthTable.innerHTML = `
    <tr>
      <th>Month</th>
      <th>Credit</th>
      <th>Debit</th>
      <th>Saving</th>
    </tr>
  `;

  const labels = [];
  const savingValues = [];

  // Build table rows
  Object.values(map)
    .sort((a, b) => a.date - b.date)
    .forEach(v => {
      const saving = v.credit - v.debit;
      const isPositive = saving >= 0;

      const label = v.date.toLocaleString("en", {
        month: "short",
        year: "numeric"
      });

      labels.push(label);
      savingValues.push(Number(saving.toFixed(2)));

      const savingClass = isPositive
        ? "month-saving-positive"
        : "month-saving-negative";

      const arrow = isPositive
        ? `<span class="saving-arrow">
            <svg stroke="#16a34a" stroke-width="2.5" fill="none" viewBox="0 0 24 24">
              <path d="M12 19V5"/>
              <path d="M5 12l7-7 7 7"/>
            </svg>
          </span>`
        : `<span class="saving-arrow">
            <svg stroke="#dc2626" stroke-width="2.5" fill="none" viewBox="0 0 24 24">
              <path d="M12 5v14"/>
              <path d="M19 12l-7 7-7-7"/>
            </svg>
          </span>`;

      monthTable.innerHTML += `
        <tr class="month-row-hover">
          <td><b>${label}</b></td>
          <td class="month-credit">‚Çπ${formatNumber(v.credit)}</td>
          <td class="month-debit">‚Çπ${formatNumber(v.debit)}</td>
          <td class="${savingClass}">
            ‚Çπ${formatNumber(saving)}
            ${arrow}
          </td>
        </tr>
      `;
    });

  // Destroy previous chart
  if (monthChart) monthChart.destroy();

  // Month-wise Savings Chart (NO SHADING, GREEN LABELS)
monthChart = new Chart(document.getElementById("monthChart"), {
  type: "line",
  data: {
    labels,
    datasets: [{
      label: "Net Saving",
      data: savingValues,
      tension: 0.45,
      borderWidth: 3,
      fill: false, // ‚úÖ NO SHADING

      // POINT STYLING
      pointRadius: 7,
      pointHoverRadius: 11,
      pointBorderWidth: 3,
      pointBorderColor: "#ffffff",

      pointBackgroundColor: ctx =>
        ctx.raw >= 0 ? "#22c55e" : "#ef4444",

      // ‚úÖ LINE COLOR PER SEGMENT (GREEN / RED)
      segment: {
        borderColor: ctx =>
          ctx.p1.parsed.y >= 0 ? "#22c55e" : "#ef4444"
      },

      // VALUE LABELS
      datalabels: {
        align: "top",
        anchor: "end",
        font: { weight: "bold", size: 12 },
        color: ctx => ctx.raw >= 0 ? "#16a34a" : "#dc2626",
        formatter: v => "‚Çπ" + formatNumber(v)
      }
    }]
  },

  plugins: [ChartDataLabels],

  options: {
    responsive: true,
    maintainAspectRatio: false,

    plugins: {
      legend: {
        display: false
      },

      tooltip: {
        backgroundColor: "#111827",
        titleColor: "#ffffff",
        bodyColor: "#e5e7eb",
        cornerRadius: 10,
        padding: 12,
        callbacks: {
          label: ctx =>
            (ctx.raw >= 0 ? "Saved: ‚Çπ" : "Loss: ‚Çπ") +
            formatNumber(Math.abs(ctx.raw))
        }
      }
    },

    scales: {
      x: {
        grid: { display: false },
        ticks: {
          color: "#6b7280",
          font: { size: 12 }
        }
      },

      y: {
        grid: {
          color: ctx =>
            ctx.tick.value === 0
              ? "rgba(0,0,0,0.35)" // center reference line
              : "rgba(0,0,0,0.06)",
          borderDash: ctx =>
            ctx.tick.value === 0 ? [6, 6] : []
        },
        ticks: {
          callback: v => "‚Çπ" + formatNumber(v),
          color: "#6b7280"
        }
      }
    },

    animation: {
      duration: 800,
      easing: "easeOutQuart"
    }
  }
});
}
/* --- Weekly chart --- */
function weeklyWise() {
  if (monthFilter.value === "") {
    weeklySection.style.display = "none";
    return;
  }
  weeklySection.style.display = "block";

  function ordinal(n) {
    return n === 1 ? "1st" :
           n === 2 ? "2nd" :
           n === 3 ? "3rd" : n + "th";
  }

  const weekRanges = [
    `${ordinal(1)} Week (1‚Äì7)`,
    `${ordinal(2)} Week (8‚Äì14)`,
    `${ordinal(3)} Week (15‚Äì21)`,
    `${ordinal(4)} Week (22‚Äì28)`,
    `${ordinal(5)} Week (29‚Äì31)`
  ];

  const weekTotals = [0, 0, 0, 0, 0];
  const weekCounts = [0, 0, 0, 0, 0];

  filteredData.forEach(r => {
    const d = parseDate(getValue(r, "date"));
    const deb = +getValue(r, "debit") || 0;

    if (deb > 0) {
      const w = Math.min(Math.floor((d.getDate() - 1) / 7), 4);
      weekTotals[w] += deb;
      weekCounts[w] += 1;
    }
  });

  const weekAverages = weekTotals.map((total, i) =>
    weekCounts[i] > 0 ? total / weekCounts[i] : 0
  );

  if (weeklyChart) weeklyChart.destroy();

  const pointColors = [
    "#4F46E5",  // Week 1
    "#8B5CF6",  // Week 2
    "#10B981",  // Week 3
    "#F59E0B",  // Week 4
    "#EF4444"   // Week 5
  ];

  weeklyChart = new Chart(document.getElementById("weeklyChart"), {
    type: "line",
    data: {
      labels: weekRanges,
      datasets: [{
        label: "Average Weekly Spending",
        data: weekAverages,
        borderWidth: 3,
        tension: 0.35,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointBackgroundColor: pointColors,
        pointHoverBackgroundColor: pointColors,
        pointHoverBorderWidth: 15,
        pointHoverBorderColor: (ctx) =>
          ctx.dataset.pointBackgroundColor[ctx.dataIndex] + "40",

        fill: true,
        backgroundColor: function(context) {
          const chart = context.chart;
          const { ctx, chartArea } = chart;
          if (!chartArea) return null;

          const gradient = ctx.createLinearGradient(
            0,
            chartArea.top,
            0,
            chartArea.bottom
          );
          gradient.addColorStop(0, "rgba(79, 70, 229, 0.35)");
          gradient.addColorStop(1, "rgba(79, 70, 229, 0.0)");
          return gradient;
        },

        segment: {
          borderColor: ctx => pointColors[ctx.p0DataIndex]
        },

        // DATA LABELS ABOVE POINTS
        datalabels: {
          align: "top",
          anchor: "end",
          color: "#374151",
          font: { weight: "bold", size: 12 },
          formatter: value => value.toFixed(2)
        }
      }]
    },

    plugins: [ChartDataLabels],

    options: {
      responsive: true,
      maintainAspectRatio: false,

      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return "Average Weekly Spending: " + context.raw.toFixed(2);
            }
          }
        }
      },

      scales: {
        y: {
          ticks: {
            callback: (value) => value.toFixed(2)
          }
        }
      },

      animation: {
        onComplete: () => {
          const chart = weeklyChart;
          const ctx = chart.ctx;
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          gradient.addColorStop(0, "rgba(79, 70, 229, 1)");
          gradient.addColorStop(1, "rgba(79, 70, 229, 0.1)");
          chart.data.datasets[0].borderColor = gradient;
          chart.update();
        }
      },

      // CLICKABLE WEEK SEGMENTS
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index; // week index (0‚Äì4)
          filterTransactionsByWeek(index);
        }
      }
    }
  });
}

/* NEW: Filter merchant table by week */
function filterTransactionsByWeek(weekIndex) {
  const start = weekIndex * 7 + 1;
  const end = Math.min(start + 6, 31);

  const filtered = rawData.filter(r => {
    const d = parseDate(getValue(r, "date"));
    const day = d.getDate();

    return (
      (!monthFilter.value || d.getMonth() == monthFilter.value) &&
      day >= start && day <= end
    );
  });

  filteredData = filtered;

  // re-render full dashboard with new filtered data
  renderAll();
}



/* --- Merchant table --- */
function merchantWise(){
  const rows = [];

  filteredData.forEach(r=>{
    const d = parseDate(getValue(r,"date"));
    rows.push({
      date: d,
      dateLabel: d.toLocaleDateString("en-GB",{day:"2-digit", month:"short", year:"numeric"}),
      merchant: getValue(r,"merchant name"),
      credit: +getValue(r,"credit") || 0,
      debit: +getValue(r,"debit") || 0
    });
  });

  rows.sort((a,b) => a.date - b.date);

  let html = `
    <tr>
      <th>Date</th>
      <th>Merchant</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>`;

   rows.forEach(r=>{
   const merchantSafe = (r.merchant && String(r.merchant)) || "-";

  const noAmount = r.credit === 0 && r.debit === 0;

  html += `
    <tr class="table-row-highlight">
      <td>${r.dateLabel}</td>

      <td 
        class="${noAmount ? "missing-amount" : ""}"
        data-original="${escapeHtml(merchantSafe)}"
      >
        ${escapeHtml(merchantSafe)}
      </td>

      <td class="${r.credit>0 ? "credit-cell" : ""}">
        ${r.credit>0 ? "‚Çπ" + formatNumber(r.credit) : "-"}
      </td>

    <td class="${r.debit>0 ? "debit-cell" : ""}">
    ${r.debit>0 ? "‚Çπ" + formatNumber(r.debit) : "-"}
    </td>


    </tr>`;
 });


  merchantTable.innerHTML = html;
  calculateTotals();
}
function merchantWiseWithData(data) {
  const rows = [];

  data.forEach(r => {
    const d = parseDate(getValue(r, "date"));

    rows.push({
      date: d,
      dateLabel: d.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric"
      }),
      merchant: getValue(r, "merchant name"),
      credit: +getValue(r, "credit") || 0,
      debit: +getValue(r, "debit") || 0
    });
  });

  // Sort by date
  rows.sort((a, b) => a.date - b.date);

  let html = `
    <tr>
      <th>Date</th>
      <th>Merchant</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>
  `;

  rows.forEach(r => {
    const merchantSafe = r.merchant || "-";

    // ‚úÖ CHECK FOR MISSING CREDIT & DEBIT
    const noAmount = r.credit === 0 && r.debit === 0;

    html += `
      <tr class="table-row-highlight">
        <td>${r.dateLabel}</td>

        <!-- Highlight merchant name if credit & debit are both missing -->
        <td class="${noAmount ? "missing-amount" : ""}">
          ${escapeHtml(merchantSafe)}
        </td>

        <td class="${r.credit > 0 ? "credit-cell" : ""}">
          ${r.credit > 0 ? "‚Çπ" + formatNumber(r.credit) : "-"}
        </td>

        <td class="${r.debit > 0 ? "debit-cell" : ""}">
          ${r.debit > 0 ? "‚Çπ" + formatNumber(r.debit) : "-"}
        </td>
      </tr>
    `;
  });

  merchantTable.innerHTML = html;
}

function syncDatePickerLimits() {
  const dateInput = document.getElementById("dateFilter");
  if (!dateInput || filteredData.length === 0) {
    return;
  }

  const dates = filteredData.map(r =>
    parseDate(getValue(r, "date"))
  );

  const minDate = new Date(Math.min(...dates));
  const maxDate = new Date(Math.max(...dates));

  const toISO = d => d.toISOString().split("T")[0];

  dateInput.min = toISO(minDate);
  dateInput.max = toISO(maxDate);
}

/* --- AI Insight --- */
function generateAIInsight(){
  const box = document.getElementById("aiInsight");
  box.style.display = "none";

  let totalCredit = 0, totalDebit = 0;
  const merchantTotals = {};
  let totalSpend = 0;

  filteredData.forEach(r=>{
    const m = getValue(r,"merchant name");
    const c = +getValue(r,"credit") || 0;
    const d = +getValue(r,"debit") || 0;
    totalCredit += c; totalDebit += d;
    if(m && d>0){
      merchantTotals[m] = (merchantTotals[m] || 0) + d;
      totalSpend += d;
    }
  });

  if(totalSpend === 0) return;

  let topMerchant = "", topAmount = 0;
  for(const m in merchantTotals){
    if(merchantTotals[m] > topAmount){
      topMerchant = m; topAmount = merchantTotals[m];
    }
  }

  const percent = ((topAmount / totalSpend) * 100).toFixed(1);
  const netSaving = totalCredit - totalDebit;

  let period = buildSummaryTitle();

  box.innerHTML = `
    üß† <b>AI Spending Insight</b><br><br>
    üìå In <b>${period}</b>, highest spending was on <b>${escapeHtml(String(topMerchant).toUpperCase())}</b> ‚Äî
    <b>‚Çπ${formatNumber(topAmount)}</b> <span style="color:#6b7280">(${percent}% of spending)</span><br><br>
    üí∞ <b>Net saving:</b> 
    <span style="color:${netSaving>=0 ? '#16a34a' : '#dc2626'}; font-weight:600">
      ‚Çπ${formatNumber(netSaving)}
    </span><br><br>
    ${ percent > 40 ? "‚ö†Ô∏è This merchant dominates your expenses." :
       percent > 25 ? "üîç This is a major expense area." :
       "‚úÖ Spending is reasonably distributed." }
  `;

  box.style.display = "block";
}
function calculateTotals() {
  let sells = 0;
  let expense = 0;

  document.querySelectorAll("#merchantTable tr").forEach((row, index) => {
    if (index === 0) return;

    const creditCell = row.children[2];
    const debitCell  = row.children[3];

    if (creditCell && creditCell.innerText.trim() !== "-") {
      sells += parseFloat(
        creditCell.innerText.replace("‚Çπ", "").replace(/,/g, "").trim()
      );
    }

    if (debitCell && debitCell.innerText.trim() !== "-") {
      expense += parseFloat(
        debitCell.innerText.replace("‚Çπ", "").replace(/,/g, "").trim()
      );
    }
  });

  document.getElementById("totalSells").innerText =
    sells.toLocaleString("en-IN", { minimumFractionDigits: 2 });

  document.getElementById("totalExpense").innerText =
    expense.toLocaleString("en-IN", { minimumFractionDigits: 2 });
}



function generateAIInsightFromData(data, label) {
  const box = document.getElementById("aiInsight");
  box.style.display = "none";

  if (!data || data.length === 0) return;

  let totalCredit = 0, totalDebit = 0;
  const merchantTotals = {};
  let totalSpend = 0;

  data.forEach(r => {
    const m = getValue(r, "merchant name");
    const c = +getValue(r, "credit") || 0;
    const d = +getValue(r, "debit") || 0;

    totalCredit += c;
    totalDebit += d;

    if (m && d > 0) {
      merchantTotals[m] = (merchantTotals[m] || 0) + d;
      totalSpend += d;
    }
  });

let topMerchant = "";
let topAmount = 0;
let percent = 0;

if (totalSpend > 0) {
  for (const m in merchantTotals) {
    if (merchantTotals[m] > topAmount) {
      topMerchant = m;
      topAmount = merchantTotals[m];
    }
  }

  percent = ((topAmount / totalSpend) * 100).toFixed(1);
 }

  const netSaving = totalCredit - totalDebit;

 let insightText = "";

 if (totalSpend > 0) {
  insightText = `
    üè™ Highest spending was on
    <b>${escapeHtml(String(topMerchant).toUpperCase())}</b> ‚Äî
    <b>‚Çπ${formatNumber(topAmount)}</b>
    <span style="color:#6b7280">(${percent}% of spending)</span>
  `;
 } else {
  insightText = `
    üí∏ No spending detected on this date.<br>
    üí∞ Only income transactions were recorded.
  `;
 }

 box.innerHTML = `
  üß† <b>AI Spending Insight</b><br><br>
  üìÖ <b>${label}</b><br><br>

  ${insightText}
  <br><br>

  üí∞ <b>Net saving:</b>
  <span style="color:${netSaving >= 0 ? '#16a34a' : '#dc2626'}; font-weight:600">
    ‚Çπ${formatNumber(netSaving)}
  </span>
`;


  box.style.display = "block";
}

/* --- Escape HTML --- */
function escapeHtml(text){
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

/* --- Initial Chart Heights --- */
(function initEmpty(){
  document.getElementById("monthChart").style.height = "400px";
  document.getElementById("weeklyChart").style.height = "400px";
})();
window.addEventListener("load", () => {
  const loader = document.getElementById("pageLoader");

  loader.classList.add("fade-out");

  setTimeout(() => {
    loader.style.display = "none";
  }, 500); // match fade-out time
});
function showToast(message, type = "success") {
  const toast = document.getElementById("uploadToast");

  toast.className = ""; // reset
  toast.classList.add(type);
  toast.innerText = message;

  // force reflow for animation reset
  toast.offsetHeight;

  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 3500);
}

</script>
<!-- Upload toast -->
<div id="uploadToast"></div>

</body>
</html>
